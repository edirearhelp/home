<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edirear</title>
    <!-- Favicon Implementation -->
    <link rel="icon" type="image/png" href="Edirear.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #000;
            color: #fff;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background-color: #000;
        }

        /* Welcome Screen Styles - Modified */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        }

        .welcome-container {
            max-width: 600px;
            width: 100%;
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .welcome-logo {
            font-weight: bold;
            font-size: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
        }

        .welcome-logo-icon {
            color: #4CAF50;
            font-size: 40px;
        }

        .welcome-title {
            font-size: 28px;
            margin-bottom: 15px;
        }

        .welcome-subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 40px;
            line-height: 1.5;
        }

        .welcome-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            width: 100%;
            margin-top: 20px;
        }

        .welcome-btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        /* Notification Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 350px;
        }

        .notification {
            background-color: #000;
            color: #fff;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            transition: transform 0.3s, opacity 0.3s;
        }

        .notification.hiding {
            transform: translateX(100%);
            opacity: 0;
        }

        .notification-icon {
            font-size: 20px;
            color: #4CAF50;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            opacity: 0.9;
        }

        .notification-close {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .notification-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Login Screen Styles */
        .login-screen {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        }

        .login-logo {
            font-weight: bold;
            font-size: 36px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
        }

        .login-logo-icon {
            color: #4CAF50;
            font-size: 40px;
        }

        .login-title {
            font-size: 28px;
            margin-bottom: 15px;
        }

        .login-subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 40px;
            max-width: 500px;
            line-height: 1.5;
        }

        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background-color: #fff;
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .google-signin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .google-signin-btn i {
            font-size: 20px;
            color: #4285F4;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            max-width: 300px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            font-weight: 500;
            flex: 1;
            text-align: left;
        }

        .sign-out-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .sign-out-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Country Selection Screen */
        .country-screen {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        }

        .country-container {
            max-width: 600px;
            width: 100%;
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .country-title {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .country-subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .country-select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #333;
            background-color: #000;
            color: #fff;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .country-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            width: 100%;
        }

        .country-btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        /* Content Setup Screen */
        .content-setup-screen {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        }

        .content-setup-container {
            max-width: 600px;
            width: '100%';
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .content-setup-title {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .content-setup-subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .content-input-group {
            display: flex;
            margin-bottom: 20px;
        }

        .content-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 8px 0 0 8px;
            border: 1px solid #333;
            background-color: #000;
            color: #fff;
            font-size: 14px;
        }

        .content-add-btn {
            padding: 12px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .content-add-btn:hover {
            background-color: #45a049;
        }

        .content-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }

        .content-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .remove-tag {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 2px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-tag:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .content-setup-buttons {
            display: flex;
            gap: 15px;
        }

        .setup-skip-btn, .setup-done-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .setup-done-btn {
            background-color: #4CAF50;
            color: white;
        }

        .setup-done-btn:hover {
            background-color: #45a049;
        }

        .setup-skip-btn {
            background-color: #555;
            color: white;
        }

        .setup-skip-btn:hover {
            background-color: #666;
        }

        /* Header Styles */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .logo {
            font-weight: bold;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .logo-icon {
            color: #4CAF50;
            font-size: 24px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .google-signin-header {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            color: #333;
            border: none;
            padding: 8px 12px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .google-signin-header:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .google-signin-header i {
            font-size: 16px;
            color: #4285F4;
        }

        .menu-icon, .search-icon, .upload-icon, .preferences-icon, .settings-icon {
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .menu-icon:hover, .search-icon:hover, .upload-icon:hover, .preferences-icon:hover, .settings-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Settings Modal Styles */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
        }

        .settings-content {
            background-color: #1a1a1a;
            margin: 50px auto;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            border-radius: 12px;
            position: relative;
        }

        .settings-title {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .settings-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .settings-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .settings-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .settings-btn:hover::before {
            left: 100%;
        }

        .settings-btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .settings-btn i {
            font-size: 16px;
            width: 20px;
        }

        /* Sign Out Button Styles */
        .signout-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .signout-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .signout-btn:hover::before {
            left: 100%;
        }

        .signout-btn:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
        }

        .signout-btn i {
            font-size: 16px;
            width: 20px;
        }

        /* Premium Button Styles */
        .premium-btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .premium-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .premium-btn:hover::before {
            left: 100%;
        }

        .premium-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4);
        }

        .premium-btn i {
            font-size: 16px;
            width: 20px;
        }

        /* Contact Options Styles */
        .contact-options {
            display: none;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .contact-option {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contact-option:hover {
            background-color: #45a049;
        }

        .contact-option i {
            font-size: 16px;
            width: 20px;
        }

        .email-display {
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
        }

        .email-address {
            font-size: 16px;
            font-weight: 500;
            color: #4CAF50;
            margin: 10px 0;
        }

        .copy-email-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .copy-email-btn:hover {
            background-color: #45a049;
        }

        /* Categories Bar Styles */
        .categories-bar {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            overflow-x: auto;
            background-color: rgba(0, 0, 0, 0.9);
            padding: 10px 15px;
            z-index: 99;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .categories-bar::-webkit-scrollbar {
            display: none;
        }

        .category-item {
            flex-shrink: 0;
            padding: 8px 16px;
            margin-right: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .category-item:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .category-item.active {
            background-color: #4CAF50;
            color: white;
        }

        /* Video Feed Styles */
        .video-feed {
            margin-top: 130px;
            margin-bottom: 70px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .video-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background-color: #1a1a1a;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .video-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 255, 255, 0.1);
        }

        .video-thumbnail-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background-color: #000;
            overflow: hidden;
        }

        .video-thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .video-item:hover .video-thumbnail {
            transform: scale(1.05);
        }

        .video-duration {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 2;
        }

        .video-info {
            padding: 12px;
        }

        .video-title {
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: 500;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .video-channel-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .video-channel-info:hover {
            opacity: 0.8;
        }

        .channel-logo-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #333;
        }

        .video-channel {
            font-size: 14px;
            opacity: 0.8;
        }

        .video-metadata {
            display: flex;
            font-size: 13px;
            opacity: 0.7;
            gap: 10px;
        }

        /* Load More Button Styles */
        .load-more-container {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        
        .load-more-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .load-more-btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .load-more-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Video Modal Styles */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background-color: #000;
            display: flex; 
            flex-direction: column;
            width: 100%;
            max-width: 900px;
            height: 100vh;
            max-height: 100vh;
            border-radius: 10px;
            position: relative;
            margin: 0 auto;
            overflow: hidden;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .close-modal:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%;
            margin-bottom: 0;
        }

        #videoPlayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* AD BANNER STYLES */
        .ad-banner-container {
            display: none;
            width: 100%;
            text-align: center;
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
        }

        .ad-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ad-banner {
            margin: 0 auto;
            overflow: hidden;
        }
        
        /* Video Actions Bar */
        .video-actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid #333;
        }

        .video-left-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .video-action-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .video-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .like-btn.liked {
            color: #ff4444;
        }

        .like-btn.liked i {
            color: #ff4444;
        }

        .video-right-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .share-dropdown {
            position: relative;
        }

        .share-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            min-width: 200px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .share-option {
            background: none;
            border: none;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.3s;
        }

        .share-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .share-option i {
            font-size: 18px;
            width: 24px;
        }

        .whatsapp-share {
            background-color: #25D366;
        }

        .whatsapp-share:hover {
            background-color: #128C7E;
        }

        .facebook-share {
            background-color: #4267B2;
        }

        .facebook-share:hover {
            background-color: #365899;
        }

        .twitter-share {
            background-color: #1DA1F2;
        }

        .twitter-share:hover {
            background-color: #0d8bd9;
        }

        .telegram-share {
            background-color: #0088cc;
        }

        .telegram-share:hover {
            background-color: #0077b5;
        }

        .copy-link {
            background-color: #555;
        }

        .copy-link:hover {
            background-color: #666;
        }

        .share-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Video Info Section */
        .scrollable-content {
            flex-grow: 1; 
            overflow-y: auto;
            padding: 0 20px 20px 20px;
        }

        /* Channel Info in Video Modal */
        .channel-info-modal {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background-color: rgba(255, 255, 255, 0.05);
            margin: 0 20px 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .channel-info-modal:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .channel-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .channel-logo-modal {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #333;
        }

        .channel-details {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .channel-name-modal {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .channel-subs-modal {
            font-size: 13px;
            opacity: 0.7;
        }

        .subscribe-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .subscribe-btn:hover {
            background-color: #45a049;
        }

        .subscribe-btn.subscribed {
            background-color: #666;
        }

        .subscribe-btn.disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .subscribe-btn.disabled:hover {
            background-color: #555;
        }

        .video-info-modal {
            margin-bottom: 15px;
            padding: 0 20px;
        }

        .video-info-modal h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .video-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .video-description {
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.5;
            opacity: 0.9;
            max-height: 63px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .video-description.expanded {
            max-height: none;
            -webkit-line-clamp: unset;
        }

        .show-more-btn {
            background: none;
            border: none;
            color: #4CAF50;
            cursor: pointer;
            padding: 5px 0;
            font-size: 14px;
            margin-top: 5px;
            text-align: left;
            display: block;
        }

        /* Comments Section Styles */
        .comments-section {
            margin-top: 30px;
            padding: 0 20px;
        }

        .comments-section h4 {
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comments-container {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 20px;
        }

        .comment-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .comment-input {
            flex: 1;
            padding: 12px 15px;
            background-color: #000;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            resize: vertical;
            min-height: 50px;
        }

        .post-comment-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            align-self: flex-start;
        }

        .post-comment-btn:hover {
            background-color: #45a049;
        }

        .post-comment-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .comments-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .comment-item {
            display: flex;
            gap: 12px;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #333;
        }

        .comment-content {
            flex: 1;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .comment-author {
            font-weight: 500;
            font-size: 14px;
        }

        .comment-time {
            font-size: 12px;
            opacity: 0.7;
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
            font-size: 12px;
            opacity: 0.7;
        }

        .comment-action {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .comment-action:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .comment-liked {
            color: #ff4444;
        }

        .loading-comments {
            text-align: center;
            padding: 20px;
            color: #888;
        }

        .no-comments {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
        }

        /* SUGGESTIONS SECTION */
        .suggestions {
            margin-top: 30px;
        }

        .suggestions h4 {
            margin-bottom: 15px;
            font-size: 18px;
            padding: 0 20px;
        }

        .suggested-videos-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 0 20px;
        }

        .suggested-video {
            background-color: #111;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .suggested-video:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(255, 255, 255, 0.05);
            background-color: #1a1a1a;
        }

        .suggested-thumbnail-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%;
            background-color: #000;
            overflow: hidden;
        }

        .suggested-thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .suggested-video:hover .suggested-thumbnail {
            transform: scale(1.05);
        }

        .suggested-info {
            padding: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .suggested-title {
            font-size: 15px;
            margin-bottom: 8px;
            font-weight: 500;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 1;
            line-height: 1.4;
        }

        .suggested-channel-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .suggested-channel-info:hover {
            opacity: 0.8;
        }

        .suggested-channel-logo {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #333;
        }

        .suggested-channel {
            font-size: 13px;
            opacity: 0.8;
        }

        .suggested-metadata {
            display: flex;
            font-size: 12px;
            opacity: 0.7;
            gap: 8px;
        }

        /* Channel Page Styles */
        .channel-page {
            display: none;
            background-color: #000;
            min-height: 100vh;
        }

        .channel-header {
            padding-top: 80px;
            background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
            position: relative;
        }

        .channel-banner {
            width: 100%;
            height: 250px;
            position: relative;
            overflow: hidden;
        }

        .channel-banner-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .channel-banner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.7));
        }

        .channel-header-content {
            max-width: 1200px;
            margin: -60px auto 20px;
            padding: 0 20px;
            display: flex;
            align-items: flex-end;
            gap: 30px;
            position: relative;
            z-index: 2;
        }

        .channel-avatar-large {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #4CAF50;
            background-color: #333;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.5);
        }

        .channel-info-header {
            flex: 1;
            padding-bottom: 20px;
        }

        .channel-name-large {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .channel-handle {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .channel-stats {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
        }

        .channel-stat {
            text-align: left;
        }

        .stat-number {
            font-size: 20px;
            font-weight: 600;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.7;
        }

        .channel-actions {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .channel-subscribe-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .channel-subscribe-btn:hover {
            background-color: #45a049;
        }

        .channel-subscribe-btn.subscribed {
            background-color: #666;
        }

        .channel-subscribe-btn.disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .channel-subscribe-btn.disabled:hover {
            background-color: #555;
        }

        .notification-btn {
            background-color: #333;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        .notification-btn:hover {
            background-color: #444;
        }

        .channel-tabs {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            border-bottom: 1px solid #333;
            display: flex;
            overflow-x: auto;
            background-color: #000;
        }

        .channel-tab {
            padding: 15px 20px;
            background: none;
            border: none;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            opacity: 0.7;
            transition: opacity 0.3s;
            white-space: nowrap;
        }

        .channel-tab:hover {
            opacity: 1;
        }

        .channel-tab.active {
            opacity: 1;
        }

        .channel-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #4CAF50;
        }

        .channel-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .channel-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .channel-videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .channel-shorts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .channel-short {
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            height: 320px;
            background-color: #111;
        }

        .channel-short-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .channel-short-title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .channel-posts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .channel-post {
            background-color: #111;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .post-content {
            padding: 20px;
        }

        .post-text {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .post-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .post-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            opacity: 0.7;
        }

        .back-to-home {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: background-color 0.3s;
        }

        .back-to-home:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        /* Channel Description Styles */
        .channel-description-container {
            margin-bottom: 30px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .channel-description-text {
            font-size: 14px;
            line-height: 1.6;
            opacity: 0.9;
            max-height: 105px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .channel-description-text.expanded {
            max-height: none;
            -webkit-line-clamp: unset;
        }

        .channel-show-more-btn {
            background: none;
            border: none;
            color: #4CAF50;
            cursor: pointer;
            padding: 5px 0;
            font-size: 14px;
            margin-top: 10px;
            text-align: left;
            display: block;
        }

        /* Upload Modal Styles */
        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
        }

        .upload-content {
            background-color: #1a1a1a;
            margin: 30px auto;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            border-radius: 12px;
            position: relative;
        }

        .upload-title {
            font-size: 20px;
            margin-bottom: 15px;
            text-align: center;
        }

        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-weight: 500;
            font-size: 13px;
        }

        .form-group input, .form-group textarea, .form-group select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #333;
            background-color: #000;
            color: #fff;
            font-size: 13px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .upload-buttons {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }

        .upload-btn, .cancel-btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-btn {
            background-color: #4CAF50;
            color: white;
        }

        .upload-btn:hover {
            background-color: #45a049;
        }

        .cancel-btn {
            background-color: #555;
            color: white;
        }

        .cancel-btn:hover {
            background-color: #666;
        }

        .thumbnail-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 8px;
            border-radius: 6px;
            display: none;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            background-color: #000;
            padding: 10px 0;
            border-top: 1px solid #333;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .nav-item.active {
            color: #4CAF50;
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 3px;
        }

        .nav-item span {
            font-size: 12px;
        }

        /* Preferences Button */
        .preferences-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            z-index: 99;
            transition: all 0.3s ease;
        }

        .preferences-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }

        .preferences-button i {
            font-size: 24px;
            color: white;
        }

        /* Preferences Modal */
        .preferences-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
        }

        .preferences-content {
            background-color: #1a1a1a;
            margin: 50px auto;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            border-radius: 12px;
            position: relative;
        }

        .preferences-title {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .preferences-subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 30px;
            line-height: 1.5;
            text-align: center;
        }

        .preferences-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .preferences-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .preferences-save-btn, .preferences-cancel-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preferences-save-btn {
            background-color: #4CAF50;
            color: white;
        }

        .preferences-save-btn:hover {
            background-color: #45a049;
        }

        .preferences-cancel-btn {
            background-color: #555;
            color: white;
        }

        .preferences-cancel-btn:hover {
            background-color: #666;
        }

        /* Loading Animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
            gap: 15px;
            grid-column: 1 / -1;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            text-align: center;
            padding: 20px;
            color: #ff5555;
            grid-column: 1 / -1;
        }

        /* CACHE STYLES */
        .channel-logo-cached {
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 16px;
        }

        /* Search Page Styles */
        .search-page {
            display: none;
            background-color: #000;
            min-height: 100vh;
            padding-top: 70px;
        }

        .search-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-to-home-search {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .back-to-home-search:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .search-bar-container {
            flex: 1;
            position: relative;
        }

        .search-bar {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border-radius: 25px;
            border: 1px solid #333;
            background-color: #1a1a1a;
            color: white;
            font-size: 16px;
        }

        .search-bar:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .search-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #888;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }

        .search-button:hover {
            color: #4CAF50;
        }

        .search-history-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .search-history-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #888;
        }

        .search-history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .search-history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background-color: #1a1a1a;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-history-item:hover {
            background-color: #222;
        }

        .search-history-icon {
            color: #888;
            font-size: 16px;
        }

        .search-history-text {
            flex: 1;
            font-size: 15px;
        }

        .clear-history-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: color 0.3s;
        }

        .clear-history-btn:hover {
            color: #4CAF50;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .search-suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-bottom: 1px solid #333;
        }

        .search-suggestion-item:last-child {
            border-bottom: none;
        }

        .search-suggestion-item:hover {
            background-color: #222;
        }

        .search-suggestion-text {
            font-size: 15px;
            color: white;
        }

        .search-suggestion-text strong {
            color: #4CAF50;
        }

        .search-results-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: none;
        }

        .search-results-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: white;
        }

        .search-video-feed {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .no-search-results {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .no-search-results i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        /* Following Page Styles */
        .following-page {
            display: none;
            background-color: #000;
            min-height: 100vh;
            padding-top: 70px;
        }

        .following-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-to-home-following {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .back-to-home-following:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .following-title {
            font-size: 20px;
            font-weight: 600;
        }

        .subscriptions-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .subscriptions-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .subscription-channel {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 15px;
            border-radius: 12px;
            background-color: rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }

        .subscription-channel:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(255, 255, 255, 0.05);
        }

        .subscription-channel-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 3px solid #4CAF50;
            background-color: #333;
        }

        .subscription-channel-name {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            margin-bottom: 5px;
        }

        .subscription-channel-handle {
            font-size: 12px;
            opacity: 0.7;
            text-align: center;
        }

        .subscription-channel-subs {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 5px;
        }

        .no-subscriptions {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
        }

        .no-subscriptions i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
            color: #4CAF50;
        }

        .no-subscriptions h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .no-subscriptions p {
            opacity: 0.7;
            margin-bottom: 20px;
        }

        .browse-channels-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .browse-channels-btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        .subscriptions-loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
        }

        /* Following Video Feed */
        .following-video-feed {
            margin-top: 70px;
            margin-bottom: 70px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Following Video Suggestions in Modal */
        .following-suggested-videos-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 0 20px;
        }

        /* Following Modal Styles */
        .following-video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
        }

        /* Video Playback Resume Notification */
        .resume-playback-notification {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .resume-playback-btn {
            background-color: white;
            color: #4CAF50;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .resume-playback-btn:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }

        .close-resume-notification {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .close-resume-notification:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .video-feed {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                padding: 10px;
                gap: 15px;
                margin-top: 110px;
            }
            
            .following-video-feed {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                padding: 10px;
                gap: 15px;
                margin-top: 110px;
            }
            
            .categories-bar {
                top: 60px;
                padding: 8px 10px;
            }
            
            .category-item {
                padding: 6px 12px;
                font-size: 14px;
            }
            
            .app-container {
                width: 100%;
            }
            
            .header {
                padding: 12px 15px;
            }
            
            .logo {
                font-size: 18px;
            }
            
            .modal-content {
                margin: 0;
                padding: 0;
                border-radius: 0;
            }
            
            .channel-header-content {
                flex-direction: column;
                align-items: center;
                text-align: center;
                margin-top: -40px;
                gap: 15px;
            }
            
            .channel-avatar-large {
                width: 100px;
                height: 100px;
            }
            
            .channel-info-header {
                text-align: center;
                padding-bottom: 10px;
            }
            
            .channel-stats {
                justify-content: center;
                gap: 20px;
            }
            
            .channel-actions {
                justify-content: center;
            }
            
            .channel-tabs {
                padding: 0 10px;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .channel-tab {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .channel-videos-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 15px;
            }
            
            .channel-shorts-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 15px;
            }
            
            .channel-short {
                height: 250px;
            }
            
            .channel-posts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .suggested-videos-container {
                grid-template-columns: 1fr;
            }
            
            .following-suggested-videos-container {
                grid-template-columns: 1fr;
            }
            
            .upload-content {
                margin: 20px;
                padding: 20px;
            }
            
            .content-setup-container {
                margin: 20px;
                padding: 20px;
            }
            
            .country-container {
                margin: 20px;
                padding: 20px;
            }
            
            .preferences-content {
                margin: 20px;
                padding: 20px;
            }
            
            .settings-content {
                margin: 20px;
                padding: 20px;
            }
            
            .google-signin-header span {
                display: none;
            }
            
            .google-signin-header {
                padding: 8px;
            }
            
            .preferences-button {
                bottom: 70px;
                right: 15px;
                width: 50px;
                height: 50px;
            }
            
            .preferences-button i {
                font-size: 20px;
            }
            
            .notification-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .welcome-container {
                margin: 20px;
                padding: 20px;
            }
            
            .video-actions-bar {
                padding: 10px 15px;
                flex-direction: column;
                gap: 10px;
            }
            
            .video-left-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .video-right-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .video-action-btn {
                padding: 6px 10px;
                font-size: 14px;
            }
            
            .comments-section {
                padding: 0 10px;
            }
            
            .comment-input-container {
                flex-direction: column;
            }
            
            .post-comment-btn {
                align-self: flex-end;
            }
            
            .channel-banner {
                height: 150px;
            }
            
            .channel-name-large {
                font-size: 24px;
            }
            
            .channel-stats {
                gap: 15px;
            }
            
            .stat-number {
                font-size: 16px;
            }
            
            .stat-label {
                font-size: 12px;
            }
            
            .search-header {
                padding: 12px 15px;
            }
            
            .search-bar {
                padding: 10px 40px 10px 12px;
                font-size: 14px;
            }
            
            .search-history-container,
            .search-results-container {
                padding: 15px;
            }
            
            .search-video-feed {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
            }
            
            .following-header {
                padding: 12px 15px;
            }
            
            .subscriptions-container {
                padding: 15px;
            }
            
            .subscriptions-list {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .subscription-channel-avatar {
                width: 70px;
                height: 70px;
            }
            
            .resume-playback-notification {
                bottom: 80px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        @media (max-width: 500px) {
            .video-feed {
                grid-template-columns: 1fr;
                padding: 8px;
                gap: 12px;
                margin-top: 110px;
            }
            
            .following-video-feed {
                grid-template-columns: 1fr;
                padding: 8px;
                gap: 12px;
                margin-top: 110px;
            }
            
            .video-item {
                margin-bottom: 0;
            }
            
            .bottom-nav {
                padding: 8px 0;
            }
            
            .nav-item span {
                font-size: 10px;
            }
            
            .login-title {
                font-size: 24px;
            }
            
            .login-logo {
                font-size: 28px;
            }
            
            .content-setup-title {
                font-size: 20px;
            }
            
            .content-setup-buttons {
                flex-direction: column;
            }
            
            .preferences-buttons {
                flex-direction: column;
            }
            
            .welcome-title {
                font-size: 24px;
            }
            
            .welcome-logo {
                font-size: 28px;
            }
            
            .channel-header-content {
                padding: 0 15px;
            }
            
            .channel-avatar-large {
                width: 80px;
                height: 80px;
            }
            
            .channel-name-large {
                font-size: 20px;
            }
            
            .channel-stats {
                gap: 10px;
            }
            
            .stat-number {
                font-size: 14px;
            }
            
            .stat-label {
                font-size: 11px;
            }
            
            .video-actions-bar {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .video-left-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .video-right-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .channel-tab {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .channel-banner {
                height: 120px;
            }
            
            .search-video-feed {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .subscriptions-list {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                gap: 12px;
            }
            
            .subscription-channel-avatar {
                width: 60px;
                height: 60px;
            }
            
            .subscription-channel-name {
                font-size: 13px;
            }
            
            .resume-playback-notification {
                padding: 10px;
                font-size: 14px;
            }
            
            .resume-playback-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
        }

        /* Web-specific styles */
        @media (min-width: 769px) {
            .header {
                padding: 15px 30px;
            }
            
            .video-feed {
                padding: 20px;
                gap: 25px;
            }
            
            .following-video-feed {
                padding: 20px;
                gap: 25px;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .app-container {
                padding-bottom: 0;
            }
        }
        
        /* Video Thumbnail Quality Fix */
        .high-quality-thumbnail {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        /* Channel Logo Loading Fix */
        .channel-logo-loading {
            background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Resume Playback Notification -->
    <div class="resume-playback-notification" id="resumePlaybackNotification" style="display: none;">
        <i class="fas fa-play-circle"></i>
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 3px;">Continue watching?</div>
            <div style="font-size: 13px; opacity: 0.9;" id="resumeVideoTitle"></div>
        </div>
        <button class="resume-playback-btn" id="resumePlaybackBtn">Resume</button>
        <button class="close-resume-notification" id="closeResumeNotification">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-container">
            <div class="welcome-logo">
                <i class="fas fa-play-circle welcome-logo-icon"></i>
                Edirear
            </div>
            <h1 class="welcome-title">Welcome to Edirear</h1>
            <p class="welcome-subtitle">Get started with personalized video recommendations from around the world</p>
            
            <button class="welcome-btn" id="getStartedBtn">Get Started</button>
        </div>
    </div>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">
            <i class="fas fa-play-circle login-logo-icon"></i>
            Edirear
        </div>
        <h1 class="login-title">Welcome to Edirear</h1>
        <p class="login-subtitle">Sign in with your Google account to access personalized video recommendations and subscribe to channels</p>
        <button class="google-signin-btn" id="googleSignIn">
            <i class="fab fa-google"></i>
            Sign in with Google
        </button>
        <button class="google-signin-btn" id="continueWithoutSignIn" style="background-color: #333; color: white; margin-top: 15px;">
            Continue Without Signing In
        </button>
        <div class="user-profile" id="userProfile" style="display: none;">
            <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
            <div id="userName" class="user-name"></div>
            <button class="sign-out-btn" id="signOutBtn">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>

    <!-- Country Selection Screen -->
    <div class="country-screen" id="countryScreen">
        <div class="country-container">
            <div class="login-logo">
                <i class="fas fa-play-circle login-logo-icon"></i>
                Edirear
            </div>
            <h2 class="country-title">Select Your Country</h2>
            <p class="country-subtitle">Choose your country to get personalized video recommendations from your region</p>
            
            <select class="country-select" id="countrySelect">
                <option value="">Select your country</option>
                <option value="US">United States</option>
                <option value="GB">United Kingdom</option>
                <option value="CA">Canada</option>
                <option value="AU">Australia</option>
                <option value="DE">Germany</option>
                <option value="FR">France</option>
                <option value="BR">Brazil</option>
                <option value="IN">India</option>
                <option value="JP">Japan</option>
                <option value="KR">South Korea</option>
                <option value="MX">Mexico</option>
                <option value="RU">Russia</option>
                <option value="ZA">South Africa</option>
                <option value="EG">Egypt</option>
                <option value="NG">Nigeria</option>
                <option value="SA">Saudi Arabia</option>
                <option value="AE">United Arab Emirates</option>
                <option value="TR">Turkey</option>
                <option value="IT">Italy</option>
                <option value="ES">Spain</option>
                <option value="NL">Netherlands</option>
                <option value="SE">Sweden</option>
                <option value="NO">Norway</option>
                <option value="DK">Denmark</option>
                <option value="FI">Finland</option>
                <option value="PL">Poland</option>
                <option value="CZ">Czech Republic</option>
                <option value="HU">Hungary</option>
                <option value="RO">Romania</option>
                <option value="GR">Greece</option>
                <option value="PT">Portugal</option>
                <option value="BE">Belgium</option>
                <option value="CH">Switzerland</option>
                <option value="AT">Austria</option>
                <option value="IE">Ireland</option>
                <option value="NZ">New Zealand</option>
                <option value="SG">Singapore</option>
                <option value="MY">Malaysia</option>
                <option value="ID">Indonesia</option>
                <option value="PH">Philippines</option>
                <option value="TH">Thailand</option>
                <option value="VN">Vietnam</option>
                <option value="PK">Pakistan</option>
                <option value="BD">Bangladesh</option>
                <option value="LK">Sri Lanka</option>
                <option value="NP">Nepal</option>
            </select>
            
            <button class="country-btn" id="saveCountryBtn">Save Country</button>
        </div>
    </div>

    <!-- Content Setup Screen -->
    <div class="content-setup-screen" id="contentSetupScreen">
        <div class="content-setup-container">
            <div class="login-logo">
                <i class="fas fa-play-circle login-logo-icon"></i>
                Edirear
            </div>
            <h2 class="content-setup-title">Personalize Your Feed</h2>
            <p class="content-setup-subtitle">Add topics, channels, or keywords you're interested in to get personalized video recommendations</p>
            
            <div class="content-input-group">
                <input type="text" class="content-input" id="contentInput" placeholder="Enter topics, channels, or keywords (e.g., Ronaldo, Osman Bey, @channelname)">
                <button class="content-add-btn" id="addContentBtn">Add</button>
            </div>
            
            <div class="content-tags" id="contentTags">
                </div>
            
            <div class="content-setup-buttons">
                <button class="setup-skip-btn" id="skipSetupBtn">Skip for Now</button>
                <button class="setup-done-btn" id="doneSetupBtn">Done</button>
            </div>
        </div>
    </div>

    <!-- Following Page -->
    <div class="following-page" id="followingPage">
        <div class="following-header">
            <button class="back-to-home-following" id="backToHomeFollowing">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="following-title">Subscriptions</div>
        </div>
        
        <div class="subscriptions-container">
            <div class="subscriptions-list" id="subscriptionsList">
                <div class="subscriptions-loading">
                    <div class="spinner"></div>
                    <div>Loading your subscriptions...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Page -->
    <div class="search-page" id="searchPage">
        <div class="search-header">
            <button class="back-to-home-search" id="backToHomeSearch">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="search-bar-container">
                <input type="text" class="search-bar" id="searchBar" placeholder="Search Edirear" autocomplete="off">
                <button class="search-button" id="searchButton">
                    <i class="fas fa-search"></i>
                </button>
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
        </div>
        
        <div class="search-history-container" id="searchHistoryContainer">
            <div class="search-history-title">Recent searches</div>
            <div class="search-history-list" id="searchHistoryList"></div>
            <button class="clear-history-btn" id="clearHistoryBtn">Clear all history</button>
        </div>
        
        <div class="search-results-container" id="searchResultsContainer">
            <h2 class="search-results-title" id="searchResultsTitle"></h2>
            <div class="search-video-feed" id="searchVideoFeed"></div>
            <div class="load-more-container" id="searchLoadMoreContainer" style="display: none;">
                <button class="load-more-btn" id="searchLoadMoreBtn">
                    <i class="fas fa-plus"></i> Load More Videos
                </button>
            </div>
        </div>
    </div>

    <!-- Channel Page (Hidden by default) -->
    <div class="channel-page" id="channelPage">
        <button class="back-to-home" id="backToHome">
            <i class="fas fa-arrow-left"></i>
        </button>
        
        <div class="channel-header">
            <div class="channel-banner" id="channelBanner">
                <div class="channel-banner-overlay"></div>
                <img class="channel-banner-img" id="channelBannerImg" src="" alt="Channel Banner" onerror="this.style.display='none'">
            </div>
            
            <div class="channel-header-content">
                <img id="channelAvatarLarge" class="channel-avatar-large channel-logo-loading" src="" alt="Channel Avatar">
                <div class="channel-info-header">
                    <h1 class="channel-name-large" id="channelNameLarge">Channel Name</h1>
                    <div class="channel-handle" id="channelHandle">@channelhandle</div>
                    
                    <div class="channel-stats" id="channelStats">
                        <div class="channel-stat">
                            <div class="stat-number" id="subscriberCount">0</div>
                            <div class="stat-label">Subscribers</div>
                        </div>
                        <div class="channel-stat">
                            <div class="stat-number" id="videoCount">0</div>
                            <div class="stat-label">Videos</div>
                        </div>
                        <div class="channel-stat">
                            <div class="stat-number" id="totalViews">0</div>
                            <div class="stat-label">Views</div>
                        </div>
                    </div>
                    
                    <div class="channel-actions">
                        <button class="channel-subscribe-btn" id="channelSubscribeBtn">Subscribe</button>
                        <button class="notification-btn">
                            <i class="fas fa-bell"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="channel-tabs">
            <button class="channel-tab active" data-tab="videos">Videos</button>
            <button class="channel-tab" data-tab="shorts">Shorts</button>
            <button class="channel-tab" data-tab="posts">Posts</button>
            <button class="channel-tab" data-tab="playlists">Playlists</button>
        </div>
        
        <div class="channel-content">
            <!-- Channel Description -->
            <div class="channel-description-container" id="channelDescriptionContainer">
                <div class="channel-description-text" id="channelDescriptionText">
                    No description available
                </div>
                <button class="channel-show-more-btn" id="channelShowMoreBtn" style="display: none;">Show more</button>
            </div>
            
            <!-- Videos Tab -->
            <div class="channel-section" id="videosTab">
                <h2 class="section-title">
                    <i class="fas fa-play-circle"></i>
                    Latest Videos
                </h2>
                <div class="channel-videos-grid" id="channelVideosGrid">
                    </div>
            </div>
            
            <!-- Shorts Tab -->
            <div class="channel-section" id="shortsTab" style="display: none;">
                <h2 class="section-title">
                    <i class="fas fa-film"></i>
                    Shorts
                </h2>
                <div class="channel-shorts-grid" id="channelShortsGrid">
                    </div>
            </div>
            
            <!-- Posts Tab -->
            <div class="channel-section" id="postsTab" style="display: none;">
                <h2 class="section-title">
                    <i class="fas fa-newspaper"></i>
                    Community Posts
                </h2>
                <div class="channel-posts-grid" id="channelPostsGrid">
                    </div>
            </div>
            
            <!-- Playlists Tab -->
            <div class="channel-section" id="playlistsTab" style="display: none;">
                <h2 class="section-title">
                    <i class="fas fa-list"></i>
                    Playlists
                </h2>
                <div class="loading">
                    <div class="spinner"></div>
                    <div>No playlists available</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer" style="display: none;">
        <div class="header">
            <div class="menu-icon">
                <i class="fas fa-bars"></i>
            </div>
            <div class="logo" id="homeLogo">
                <i class="fas fa-play-circle logo-icon"></i>
                Edirear
            </div>
            <div class="header-right">
                <button class="google-signin-header" id="googleSignInHeader" style="display: none;">
                    <i class="fab fa-google"></i>
                    <span>Sign In</span>
                </button>
                <div class="upload-icon" id="uploadIcon" style="display: none;">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="preferences-icon" id="preferencesIcon">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="settings-icon" id="settingsIcon">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="search-icon" id="searchIconTop">
                    <i class="fas fa-search"></i>
                </div>
            </div>
        </div>

        <!-- Categories Bar -->
        <div class="categories-bar" id="categoriesBar">
            <div class="category-item active" data-category="0">All</div>
            <div class="category-item" data-category="1">Film & Animation</div>
            <div class="category-item" data-category="2">Autos & Vehicles</div>
            <div class="category-item" data-category="10">Music</div>
            <div class="category-item" data-category="15">Pets & Animals</div>
            <div class="category-item" data-category="17">Sports</div>
            <div class="category-item" data-category="20">Gaming</div>
            <div class="category-item" data-category="22">People & Blogs</div>
            <div class="category-item" data-category="23">Comedy</div>
            <div class="category-item" data-category="24">Entertainment</div>
            <div class="category-item" data-category="25">News & Politics</div>
            <div class="category-item" data-category="26">Howto & Style</div>
            <div class="category-item" data-category="27">Education</div>
            <div class="category-item" data-category="28">Science & Technology</div>
        </div>

        <div class="video-feed" id="videoFeed">
            </div>

        <div class="preferences-button" id="preferencesButton">
            <i class="fas fa-heart"></i>
        </div>

        <!-- Video Modal -->
        <div class="video-modal" id="videoModal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <div class="video-container">
                    <div id="videoPlayer"></div>
                </div>
                
                <!-- AD BANNER CONTAINER -->
                <div class="ad-banner-container" id="adBannerContainer">
                    <div class="ad-label">Advertisement</div>
                    <div class="ad-banner" id="adBanner">
                        <script>
                            atOptions = {
                                'key' : '112e19cccef17fa151ff3e1ec2533266',
                                'format' : 'iframe',
                                'height' : 90,
                                'width' : 728,
                                'params' : {}
                            };
                        </script>
                        <script src="https://www.highperformanceformat.com/112e19cccef17fa151ff3e1ec2533266/invoke.js"></script>
                    </div>
                </div>
                
                <!-- Video Actions Bar -->
                <div class="video-actions-bar">
                    <div class="video-left-actions">
                        <button class="video-action-btn like-btn" id="likeBtn">
                            <i class="far fa-thumbs-up"></i>
                            <span id="likeCount">0</span>
                        </button>
                        <button class="video-action-btn" id="dislikeBtn" style="display: none;">
                            <i class="far fa-thumbs-down"></i>
                            <span id="dislikeCount">0</span>
                        </button>
                        <button class="video-action-btn" id="addToPlaylistBtn">
                            <i class="far fa-save"></i>
                            <span>Save</span>
                        </button>
                    </div>
                    <div class="video-right-actions">
                        <div class="share-dropdown">
                            <button class="share-btn" id="shareBtn">
                                <i class="fas fa-share-alt"></i>
                                <span>Share</span>
                            </button>
                            <div class="share-menu" id="shareMenu">
                                <button class="share-option whatsapp-share" id="whatsappShare">
                                    <i class="fab fa-whatsapp"></i>
                                    WhatsApp
                                </button>
                                <button class="share-option facebook-share" id="facebookShare">
                                    <i class="fab fa-facebook"></i>
                                    Facebook
                                </button>
                                <button class="share-option twitter-share" id="twitterShare">
                                    <i class="fab fa-twitter"></i>
                                    Twitter
                                </button>
                                <button class="share-option telegram-share" id="telegramShare">
                                    <i class="fab fa-telegram"></i>
                                    Telegram
                                </button>
                                <button class="share-option copy-link" id="copyLinkBtn">
                                    <i class="fas fa-link"></i>
                                    Copy Link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="scrollable-content">
                    <!-- Channel Info in Video Modal -->
                    <div class="channel-info-modal" id="channelInfoModal">
                        <div class="channel-left">
                            <img id="channelLogoModal" class="channel-logo-modal channel-logo-loading" src="" alt="Channel Logo">
                            <div class="channel-details">
                                <div class="channel-name-modal" id="channelNameModal">Channel Name</div>
                                <div class="channel-subs-modal" id="channelSubsModal">0 subscribers</div>
                            </div>
                        </div>
                        <button class="subscribe-btn" id="modalSubscribeBtn">Subscribe</button>
                    </div>
                    
                    <div class="video-info-modal">
                        <h3 id="videoTitle"></h3>
                        <div class="video-stats">
                            <span id="videoViews"></span>
                            <span id="videoLikes"></span>
                            <span id="videoComments"></span>
                        </div>
                        <div id="videoDescription" class="video-description"></div>
                        <button id="showMoreBtn" class="show-more-btn" style="display: none;">Show more</button>
                    </div>
                    
                    <!-- COMMENTS SECTION -->
                    <div class="comments-section" id="commentsSection">
                        <h4>
                            <i class="fas fa-comments"></i>
                            Comments <span id="commentsCount">0</span>
                        </h4>
                        <div class="comments-container">
                            <div class="comment-input-container">
                                <textarea class="comment-input" id="commentInput" placeholder="Add a public comment..." maxlength="5000"></textarea>
                                <button class="post-comment-btn" id="postCommentBtn" disabled>Comment</button>
                            </div>
                            <div class="comments-list" id="commentsList">
                                <div class="loading-comments">
                                    <div class="spinner" style="width: 20px; height: 20px; margin: 0 auto 10px;"></div>
                                    Loading comments...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SUGGESTIONS SECTION -->
                    <div class="suggestions">
                        <h4>More Videos</h4>
                        <div class="suggested-videos-container" id="suggestedVideos">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Modal -->
        <div class="upload-modal" id="uploadModal">
            <div class="upload-content">
                <span class="close-modal" id="closeUploadModal">&times;</span>
                <h2 class="upload-title">Upload Video to YouTube</h2>
                <form class="upload-form" id="uploadForm">
                    <div class="form-group">
                        <label for="videoTitleInput">Video Title</label>
                        <input type="text" id="videoTitleInput" required>
                    </div>
                    <div class="form-group">
                        <label for="videoDescription">Description</label>
                        <textarea id="videoDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="videoPrivacy">Privacy Status</label>
                        <select id="videoPrivacy" required>
                            <option value="private">Private</option>
                            <option value="public">Public</option>
                            <option value="unlisted">Unlisted</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="videoCategory">Category</label>
                        <select id="videoCategory" required>
                            <option value="">Select a category</option>
                            <option value="1">Film & Animation</option>
                            <option value="2">Autos & Vehicles</option>
                            <option value="10">Music</option>
                            <option value="15">Pets & Animals</option>
                            <option value="17">Sports</option>
                            <option value="20">Gaming</option>
                            <option value="22">People & Blogs</option>
                            <option value="23">Comedy</option>
                            <option value="24">Entertainment</option>
                            <option value="25">News & Politics</option>
                            <option value="26">Howto & Style</option>
                            <option value="27">Education</option>
                            <option value="28">Science & Technology</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="videoTags">Tags (comma separated)</label>
                        <input type="text" id="videoTags">
                    </div>
                    <div class="form-group">
                        <label for="videoThumbnail">Thumbnail (Optional)</label>
                        <input type="file" id="videoThumbnail" accept="image/*">
                        <img id="thumbnailPreview" class="thumbnail-preview" src="" alt="Thumbnail Preview">
                    </div>
                    <div class="form-group">
                        <label for="videoFile">Video File</label>
                        <input type="file" id="videoFile" accept="video/*" required>
                    </div>
                    <div class="upload-buttons">
                        <button type="button" class="cancel-btn" id="cancelUpload">Cancel</button>
                        <button type="submit" class="upload-btn">Upload</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preferences Modal -->
        <div class="preferences-modal" id="preferencesModal">
            <div class="preferences-content">
                <span class="close-modal" id="closePreferencesModal">&times;</span>
                <h2 class="preferences-title">Update Your Preferences</h2>
                <p class="preferences-subtitle">Add or remove topics, channels, or keywords to update your personalized video recommendations</p>
                
                <div class="content-input-group">
                    <input type="text" class="content-input" id="preferencesInput" placeholder="Enter topics, channels, or keywords (e.g., Ronaldo, Osman Bey, @channelname)">
                    <button class="content-add-btn" id="addPreferencesBtn">Add</button>
                </div>
                
                <div class="content-tags" id="preferencesTags">
                    </div>
                
                <div class="preferences-buttons">
                    <button class="preferences-cancel-btn" id="cancelPreferencesBtn">Cancel</button>
                    <button class="preferences-save-btn" id="savePreferencesBtn">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="settings-modal" id="settingsModal">
            <div class="settings-content">
                <span class="close-modal" id="closeSettingsModal">&times;</span>
                <h2 class="settings-title">Settings</h2>
                
                <div class="settings-buttons">
                    <button class="settings-btn" id="privacyPolicyBtn">
                        <i class="fas fa-shield-alt"></i>
                        Privacy Policy
                    </button>
                    <button class="settings-btn" id="contactUsBtn">
                        <i class="fas fa-envelope"></i>
                        Contact Us
                    </button>
                    <button class="settings-btn" id="edirearStudioBtn">
                        <i class="fas fa-play-circle"></i>
                        Edirear Studio
                    </button>
                    <button class="premium-btn" id="premiumBtn">
                        <i class="fas fa-crown"></i>
                        Premium
                    </button>
                    <button class="settings-btn" id="gameBtn">
                        <i class="fas fa-gamepad"></i>
                        Play Game
                    </button>
                    <button class="signout-btn" id="settingsSignOutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        Sign Out
                    </button>
                </div>
                
                <div class="contact-options" id="contactOptions">
                    <button class="contact-option" id="whatsappOption">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-option" id="emailOption">
                        <i class="fas fa-envelope"></i>
                        Email
                    </button>
                </div>
                
                <div class="email-display" id="emailDisplay" style="display: none;">
                    <p>Contact us via email:</p>
                    <div class="email-address">edirearhelp@gmail.com</div>
                    <button class="copy-email-btn" id="copyEmailBtn">Copy Email</button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" data-page="shorts">
                <i class="fas fa-play-circle"></i>
                <span>Shorts</span>
            </div>
            <div class="nav-item" data-page="search">
                <i class="fas fa-search"></i>
                <span>Search</span>
            </div>
            <div class="nav-item" data-page="following">
                <i class="fas fa-user-friends"></i>
                <span>Following</span>
            </div>
            <div class="nav-item" data-page="you">
                <i class="fas fa-user"></i>
                <span>You</span>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCR-RUqSbUERmWICk5o9WpeLDujHRzC_gE",
            authDomain: "edirear-248fe.firebaseapp.com",
            projectId: "edirear-248fe",
            storageBucket: "edirear-248fe.firebasestorage.app",
            messagingSenderId: "258995479060",
            appId: "1:258995479060:web:b97e587ad950ade0cfbd01",
            measurementId: "G-SY5D8DHGPC"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        // VAPID Key
        const VAPID_KEY = "BMg-Qm7rd6vgPLkQ67De65LGetIpMbBzPe-AOUUIj0LDovMB2X7ApEf3RcLTSjr0nHX1gcySxNz4S-SIzzRpgL0";

        // YouTube API Key for Subscriptions and Channel Data
        const SUBSCRIPTION_API_KEY = "AIzaSyAiq3RJkLkF1SL9TBy-Rw_VOW6CWh_XHbU";
        
        // YouTube API Keys for Search functionality
        const SEARCH_API_KEYS = [
            'AIzaSyCkC8eDdNX5PRSjkU-6r1BvF6Hz6mU7btA',
            'AIzaSyBJ-29qrzhDl3L40Z3uxw6QxqzvmWklSyI',
            'AIzaSyCuCv9HGvzOyeEZuaXRqeOCHjZIbor8LHY',
            'AIzaSyBSc3ImBS52xsFKRL2bWHqxK8-9-tRzRxA'
        ];
        
        // YouTube API Keys for Load More functionality
        const API_KEYS = [
            'AIzaSyB4Kdd9AF-L2EHkf05w3m3gL6yHh8ke4gc',
            'AIzaSyBpSSgagHJ65QMbJIR_bJNcQ6SH7nEbJC0',
            'AIzaSyCkvg9B5X0lep558_oSxqfL4O6yucwNjds'
        ];
        
        // Google OAuth Client ID
        const CLIENT_ID = '380562358749-eiv543e4rphg4v5sj569j2r2kk6b9qdm.apps.googleusercontent.com';
        
        // DOM Elements
        const welcomeScreen = document.getElementById('welcomeScreen');
        const getStartedBtn = document.getElementById('getStartedBtn');
        
        const loginScreen = document.getElementById('loginScreen');
        const countryScreen = document.getElementById('countryScreen');
        const countrySelect = document.getElementById('countrySelect');
        const saveCountryBtn = document.getElementById('saveCountryBtn');
        const contentSetupScreen = document.getElementById('contentSetupScreen');
        const appContainer = document.getElementById('appContainer');
        const googleSignInBtn = document.getElementById('googleSignIn');
        const continueWithoutSignInBtn = document.getElementById('continueWithoutSignIn');
        const googleSignInHeader = document.getElementById('googleSignInHeader');
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const signOutBtn = document.getElementById('signOutBtn');
        const contentInput = document.getElementById('contentInput');
        const addContentBtn = document.getElementById('addContentBtn');
        const contentTags = document.getElementById('contentTags');
        const skipSetupBtn = document.getElementById('skipSetupBtn');
        const doneSetupBtn = document.getElementById('doneSetupBtn');
        const videoFeed = document.getElementById('videoFeed');
        const videoModal = document.getElementById('videoModal');
        const closeModal = document.querySelector('.close-modal');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoTitle = document.getElementById('videoTitle');
        const videoViews = document.getElementById('videoViews');
        const videoLikes = document.getElementById('videoLikes');
        const videoComments = document.getElementById('videoComments');
        const suggestedVideos = document.getElementById('suggestedVideos');
        const menuIcon = document.querySelector('.menu-icon');
        const searchIconTop = document.getElementById('searchIconTop');
        const preferencesIcon = document.getElementById('preferencesIcon');
        const settingsIcon = document.getElementById('settingsIcon');
        const navItems = document.querySelectorAll('.nav-item');
        const uploadIcon = document.getElementById('uploadIcon');
        const uploadModal = document.getElementById('uploadModal');
        const closeUploadModal = document.getElementById('closeUploadModal');
        const cancelUpload = document.getElementById('cancelUpload');
        const uploadForm = document.getElementById('uploadForm');
        const videoThumbnail = document.getElementById('videoThumbnail');
        const thumbnailPreview = document.getElementById('thumbnailPreview');
        const preferencesButton = document.getElementById('preferencesButton');
        const preferencesModal = document.getElementById('preferencesModal');
        const closePreferencesModal = document.getElementById('closePreferencesModal');
        const preferencesInput = document.getElementById('preferencesInput');
        const addPreferencesBtn = document.getElementById('addPreferencesBtn');
        const preferencesTags = document.getElementById('preferencesTags');
        const cancelPreferencesBtn = document.getElementById('cancelPreferencesBtn');
        const savePreferencesBtn = document.getElementById('savePreferencesBtn');
        const notificationContainer = document.getElementById('notificationContainer');
        const categoriesBar = document.getElementById('categoriesBar');
        const categoryItems = document.querySelectorAll('.category-item');
        const homeLogo = document.getElementById('homeLogo');
        
        // AD BANNER Elements
        const adBannerContainer = document.getElementById('adBannerContainer');
        
        // Settings Modal Elements
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const privacyPolicyBtn = document.getElementById('privacyPolicyBtn');
        const contactUsBtn = document.getElementById('contactUsBtn');
        const edirearStudioBtn = document.getElementById('edirearStudioBtn');
        const premiumBtn = document.getElementById('premiumBtn');
        const gameBtn = document.getElementById('gameBtn');
        const contactOptions = document.getElementById('contactOptions');
        const whatsappOption = document.getElementById('whatsappOption');
        const emailOption = document.getElementById('emailOption');
        const emailDisplay = document.getElementById('emailDisplay');
        const copyEmailBtn = document.getElementById('copyEmailBtn');
        const settingsSignOutBtn = document.getElementById('settingsSignOutBtn');
        
        // Search Page Elements
        const searchPage = document.getElementById('searchPage');
        const backToHomeSearch = document.getElementById('backToHomeSearch');
        const searchBar = document.getElementById('searchBar');
        const searchButton = document.getElementById('searchButton');
        const searchSuggestions = document.getElementById('searchSuggestions');
        const searchHistoryContainer = document.getElementById('searchHistoryContainer');
        const searchHistoryList = document.getElementById('searchHistoryList');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        const searchResultsTitle = document.getElementById('searchResultsTitle');
        const searchVideoFeed = document.getElementById('searchVideoFeed');
        const searchLoadMoreContainer = document.getElementById('searchLoadMoreContainer');
        const searchLoadMoreBtn = document.getElementById('searchLoadMoreBtn');
        
        // Following Page Elements
        const followingPage = document.getElementById('followingPage');
        const backToHomeFollowing = document.getElementById('backToHomeFollowing');
        const subscriptionsList = document.getElementById('subscriptionsList');
        
        // Channel Page Elements
        const channelPage = document.getElementById('channelPage');
        const backToHome = document.getElementById('backToHome');
        const channelBanner = document.getElementById('channelBanner');
        const channelBannerImg = document.getElementById('channelBannerImg');
        const channelAvatarLarge = document.getElementById('channelAvatarLarge');
        const channelNameLarge = document.getElementById('channelNameLarge');
        const channelHandle = document.getElementById('channelHandle');
        const channelStats = document.getElementById('channelStats');
        const subscriberCount = document.getElementById('subscriberCount');
        const videoCount = document.getElementById('videoCount');
        const totalViews = document.getElementById('totalViews');
        const channelSubscribeBtn = document.getElementById('channelSubscribeBtn');
        const channelTabs = document.querySelectorAll('.channel-tab');
        const channelVideosGrid = document.getElementById('channelVideosGrid');
        const channelShortsGrid = document.getElementById('channelShortsGrid');
        const channelPostsGrid = document.getElementById('channelPostsGrid');
        const channelDescriptionText = document.getElementById('channelDescriptionText');
        const channelShowMoreBtn = document.getElementById('channelShowMoreBtn');
        const channelDescriptionContainer = document.getElementById('channelDescriptionContainer');
        
        // Video Modal Channel Elements
        const channelInfoModal = document.getElementById('channelInfoModal');
        const channelLogoModal = document.getElementById('channelLogoModal');
        const channelNameModal = document.getElementById('channelNameModal');
        const channelSubsModal = document.getElementById('channelSubsModal');
        const modalSubscribeBtn = document.getElementById('modalSubscribeBtn');
        
        // Video Actions Elements
        const likeBtn = document.getElementById('likeBtn');
        const dislikeBtn = document.getElementById('dislikeBtn');
        const likeCount = document.getElementById('likeCount');
        const dislikeCount = document.getElementById('dislikeCount');
        const addToPlaylistBtn = document.getElementById('addToPlaylistBtn');
        const shareBtn = document.getElementById('shareBtn');
        const shareMenu = document.getElementById('shareMenu');
        const whatsappShare = document.getElementById('whatsappShare');
        const facebookShare = document.getElementById('facebookShare');
        const twitterShare = document.getElementById('twitterShare');
        const telegramShare = document.getElementById('telegramShare');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const videoDescription = document.getElementById('videoDescription');
        const showMoreBtn = document.getElementById('showMoreBtn');
        
        // Comments Elements
        const commentsSection = document.getElementById('commentsSection');
        const commentsList = document.getElementById('commentsList');
        const commentInput = document.getElementById('commentInput');
        const postCommentBtn = document.getElementById('postCommentBtn');
        const commentsCount = document.getElementById('commentsCount');
        
        // Resume Playback Elements
        const resumePlaybackNotification = document.getElementById('resumePlaybackNotification');
        const resumePlaybackBtn = document.getElementById('resumePlaybackBtn');
        const closeResumeNotification = document.getElementById('closeResumeNotification');
        const resumeVideoTitle = document.getElementById('resumeVideoTitle');
        
        // Current video data
        let currentVideo = null;
        let userVideos = [];
        let googleUser = null;
        let accessToken = null;
        let tokenExpiry = null;
        let tokenClient = null;
        let isSignedIn = false;
        let userInterests = [];
        let userCountry = '';
        let currentCategory = '0';
        
        // Load More functionality variables
        let currentApiKeyIndex = 0;
        let nextPageToken = null;
        let isLoadingMore = false;
        let currentSearchQuery = '';
        
        // Search functionality variables
        let searchApiKeyIndex = 0;
        let searchNextPageToken = null;
        let isSearchLoadingMore = false;
        let currentSearchTerm = '';
        let searchHistory = [];
        let searchSuggestionsTimeout = null;
        
        // Channel data
        let currentChannelData = null;
        let subscribedChannels = JSON.parse(localStorage.getItem('edirear_subscribed_channels') || '[]');
        
        // Video likes data
        let likedVideos = JSON.parse(localStorage.getItem('edirear_liked_videos') || '{}');
        let videoLikedStatus = false;
        
        // Shorts player state
        let isShortsPlaying = false;
        let shortsVideoId = null;
        
        // Channel logo cache
        let channelLogoCache = {};
        
        // Channel videos cache
        let channelVideosCache = {};
        
        // Comments data
        let videoCommentsData = [];
        let commentInterval = null;
        
        // Subscriptions data
        let subscriptionsData = [];
        
        // Video Playback Resume System
        let videoPlaybackData = {
            videoId: null,
            videoTitle: null,
            timestamp: null,
            duration: null,
            channelId: null,
            channelName: null
        };
        
        // YouTube Player API
        let player = null;
        let playerInterval = null;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Load cache from localStorage
            loadCacheFromStorage();
            
            // Load search history
            loadSearchHistory();
            
            // Load video playback data
            loadVideoPlaybackData();
            
            // Check if user has already completed setup
            userCountry = localStorage.getItem('edirear_user_country') || '';
            userInterests = JSON.parse(localStorage.getItem('edirear_interests') || '[]');
            const hasSetPreferences = localStorage.getItem('edirear_preferences_set');
            
            // Check if user is returning
            const isReturningUser = localStorage.getItem('edirear_welcome_shown');
            
            if (isReturningUser) {
                // Returning user - skip welcome screen
                welcomeScreen.style.display = 'none';
                
                if (!userCountry) {
                    // User hasn't selected country yet
                    showCountrySelection();
                } else if (!hasSetPreferences && userInterests.length === 0) {
                    // First time user - show content setup
                    showContentSetup();
                } else {
                    // User has preferences set or skipped - go directly to app
                    checkAuthStatus();
                }
            } else {
                // New user - show welcome screen
                welcomeScreen.style.display = 'flex';
                localStorage.setItem('edirear_welcome_shown', 'true');
            }
            
            setupEventListeners();
            
            // Initialize Firebase Messaging
            initFirebaseMessaging();
            
            // Initialize Google OAuth2 Client
            initializeGoogleOAuth();
            
            // Check for resume playback on page load
            setTimeout(checkResumePlayback, 500);
        });
        
        // Function to save authentication data for cross-domain access
        function saveAuthDataForCrossDomain() {
            if (googleUser && accessToken && tokenExpiry) {
                try {
                    // Save with a more specific key for cross-domain access
                    const authData = {
                        user: googleUser,
                        accessToken: accessToken,
                        tokenExpiry: tokenExpiry,
                        timestamp: Date.now()
                    };
                    
                    // Use localStorage with a specific key that other pages can access
                    localStorage.setItem('edirear_auth_data', JSON.stringify(authData));
                    
                    // Also save in sessionStorage for immediate access
                    sessionStorage.setItem('edirear_auth_data', JSON.stringify(authData));
                    
                    console.log('Auth data saved for cross-domain access');
                } catch (error) {
                    console.error('Error saving auth data for cross-domain:', error);
                }
            }
        }
        
        // Function to load authentication data from storage
        function loadAuthDataFromStorage() {
            try {
                // Try to load from localStorage first (for cross-domain)
                const savedAuthData = localStorage.getItem('edirear_auth_data');
                if (savedAuthData) {
                    const authData = JSON.parse(savedAuthData);
                    
                    // Check if token is still valid (not expired and less than 1 hour old)
                    const currentTime = Date.now();
                    const isTokenValid = currentTime < authData.tokenExpiry && 
                                       (currentTime - authData.timestamp) < (60 * 60 * 1000); // 1 hour
                    
                    if (isTokenValid && authData.user && authData.accessToken) {
                        googleUser = authData.user;
                        accessToken = authData.accessToken;
                        tokenExpiry = authData.tokenExpiry;
                        isSignedIn = true;
                        
                        // Also update sessionStorage
                        sessionStorage.setItem('edirear_auth_data', savedAuthData);
                        
                        console.log('Auth data loaded from storage');
                        return true;
                    } else {
                        // Token expired or invalid
                        clearAuthData();
                        console.log('Token expired, clearing auth data');
                    }
                }
                
                // Fallback to old localStorage format
                const savedUser = localStorage.getItem('edirear_user');
                const savedToken = localStorage.getItem('edirear_access_token');
                const savedTokenExpiry = localStorage.getItem('edirear_token_expiry');
                
                if (savedUser && savedToken && savedTokenExpiry) {
                    googleUser = JSON.parse(savedUser);
                    accessToken = savedToken;
                    tokenExpiry = parseInt(savedTokenExpiry);
                    isSignedIn = true;
                    
                    // Migrate to new format
                    saveAuthDataForCrossDomain();
                    
                    return true;
                }
            } catch (error) {
                console.error('Error loading auth data from storage:', error);
            }
            
            return false;
        }
        
        // Function to clear authentication data
        function clearAuthData() {
            // Clear all auth-related data
            localStorage.removeItem('edirear_auth_data');
            localStorage.removeItem('edirear_user');
            localStorage.removeItem('edirear_access_token');
            localStorage.removeItem('edirear_token_expiry');
            sessionStorage.removeItem('edirear_auth_data');
            
            googleUser = null;
            accessToken = null;
            tokenExpiry = null;
            isSignedIn = false;
        }
        
        // Load video playback data from localStorage
        function loadVideoPlaybackData() {
            try {
                const savedData = localStorage.getItem('edirear_video_playback');
                if (savedData) {
                    videoPlaybackData = JSON.parse(savedData);
                }
            } catch (error) {
                console.error('Error loading video playback data:', error);
                videoPlaybackData = {
                    videoId: null,
                    videoTitle: null,
                    timestamp: null,
                    duration: null,
                    channelId: null,
                    channelName: null
                };
            }
        }
        
        // Save video playback data to localStorage
        function saveVideoPlaybackData() {
            try {
                localStorage.setItem('edirear_video_playback', JSON.stringify(videoPlaybackData));
            } catch (error) {
                console.error('Error saving video playback data:', error);
            }
        }
        
        // Check if we should show resume playback notification
        function checkResumePlayback() {
            if (videoPlaybackData.videoId && videoPlaybackData.timestamp) {
                // Check if video was playing less than 24 hours ago
                const timeSincePlayback = Date.now() - videoPlaybackData.timestamp;
                const twentyFourHours = 24 * 60 * 60 * 1000;
                
                if (timeSincePlayback < twentyFourHours) {
                    // Show resume playback notification
                    showResumePlaybackNotification();
                } else {
                    // Clear old playback data
                    clearVideoPlaybackData();
                }
            }
        }
        
        // Show resume playback notification
        function showResumePlaybackNotification() {
            if (!videoPlaybackData.videoId || !videoPlaybackData.videoTitle) return;
            
            resumeVideoTitle.textContent = videoPlaybackData.videoTitle;
            resumePlaybackNotification.style.display = 'flex';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (resumePlaybackNotification.style.display === 'flex') {
                    resumePlaybackNotification.style.display = 'none';
                }
            }, 10000);
        }
        
        // Hide resume playback notification
        function hideResumePlaybackNotification() {
            resumePlaybackNotification.style.display = 'none';
        }
        
        // Resume playback from saved position
        async function resumePlayback() {
            if (!videoPlaybackData.videoId) return;
            
            hideResumePlaybackNotification();
            
            try {
                // Fetch video data
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoPlaybackData.videoId}&key=${API_KEYS[0]}`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.items && data.items.length > 0) {
                        const video = data.items[0];
                        
                        // Update video playback data with latest info
                        videoPlaybackData.videoTitle = video.snippet.title;
                        videoPlaybackData.channelId = video.snippet.channelId;
                        videoPlaybackData.channelName = video.snippet.channelTitle;
                        saveVideoPlaybackData();
                        
                        // Open video modal
                        openVideoModal(video);
                        
                        // Show notification
                        showNotification('Resuming Playback', `Continuing from ${formatTime(videoPlaybackData.duration)}`);
                    } else {
                        showNotification('Video Not Found', 'The video you were watching is no longer available.');
                        clearVideoPlaybackData();
                    }
                }
            } catch (error) {
                console.error('Error resuming playback:', error);
                showNotification('Error', 'Failed to resume playback. Please try again.');
            }
        }
        
        // Clear video playback data
        function clearVideoPlaybackData() {
            videoPlaybackData = {
                videoId: null,
                videoTitle: null,
                timestamp: null,
                duration: null,
                channelId: null,
                channelName: null
            };
            saveVideoPlaybackData();
        }
        
        // Format time in seconds to MM:SS or HH:MM:SS
        function formatTime(seconds) {
            if (!seconds) return '0:00';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        // Save current video playback position
        function saveCurrentPlaybackPosition() {
            if (!currentVideo || !player) return;
            
            // Get current time from player
            try {
                const currentTime = player.getCurrentTime();
                const duration = player.getDuration();
                
                // Only save if video has been watched for at least 30 seconds
                if (currentTime > 30 && duration > 0) {
                    videoPlaybackData = {
                        videoId: currentVideo.id,
                        videoTitle: currentVideo.snippet.title,
                        timestamp: Date.now(),
                        duration: currentTime,
                        channelId: currentVideo.snippet.channelId,
                        channelName: currentVideo.snippet.channelTitle
                    };
                    saveVideoPlaybackData();
                }
            } catch (error) {
                console.error('Error saving playback position:', error);
            }
        }
        
        // Load YouTube IFrame API
        function loadYouTubeIframeAPI() {
            if (window.YT && window.YT.Player) return;
            
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }
        
        // Initialize YouTube Player
        function onYouTubeIframeAPIReady() {
            // This function will be called by YouTube API
            console.log('YouTube IFrame API ready');
        }
        
        // Create YouTube player
        function createYouTubePlayer(videoId, startSeconds = 0) {
            // Clear existing player interval
            if (playerInterval) {
                clearInterval(playerInterval);
                playerInterval = null;
            }
            
            // Clear existing player
            if (player) {
                player.destroy();
                player = null;
            }
            
            // Load the API if not already loaded
            loadYouTubeIframeAPI();
            
            // Wait for API to be ready
            const checkAPI = setInterval(() => {
                if (window.YT && window.YT.Player) {
                    clearInterval(checkAPI);
                    
                    player = new YT.Player('videoPlayer', {
                        height: '100%',
                        width: '100%',
                        videoId: videoId,
                        playerVars: {
                            'autoplay': 1,
                            'controls': 1,
                            'modestbranding': 1,
                            'rel': 0,
                            'showinfo': 0,
                            'enablejsapi': 1,
                            'origin': window.location.origin,
                            'start': startSeconds
                        },
                        events: {
                            'onReady': onPlayerReady,
                            'onStateChange': onPlayerStateChange,
                            'onError': onPlayerError
                        }
                    });
                }
            }, 100);
        }
        
        // Player ready event
        function onPlayerReady(event) {
            console.log('YouTube Player ready');
            
            // Start interval to save playback position every 10 seconds
            playerInterval = setInterval(() => {
                saveCurrentPlaybackPosition();
            }, 10000);
        }
        
        // Player state change event
        function onPlayerStateChange(event) {
            // Save playback position when video ends or is paused
            if (event.data === YT.PlayerState.ENDED || event.data === YT.PlayerState.PAUSED) {
                saveCurrentPlaybackPosition();
            }
            
            // Clear playback data when video ends
            if (event.data === YT.PlayerState.ENDED) {
                clearVideoPlaybackData();
            }
        }
        
        // Player error event
        function onPlayerError(event) {
            console.error('YouTube Player error:', event.data);
            showNotification('Playback Error', 'Failed to play video. Please try again.');
        }
        
        // Load search history from localStorage
        function loadSearchHistory() {
            try {
                const savedHistory = localStorage.getItem('edirear_search_history');
                if (savedHistory) {
                    searchHistory = JSON.parse(savedHistory);
                    displaySearchHistory();
                }
            } catch (error) {
                console.error('Error loading search history:', error);
                searchHistory = [];
            }
        }
        
        // Save search history to localStorage
        function saveSearchHistory() {
            try {
                localStorage.setItem('edirear_search_history', JSON.stringify(searchHistory));
            } catch (error) {
                console.error('Error saving search history:', error);
            }
        }
        
        // Add search term to history
        function addToSearchHistory(term) {
            if (!term.trim()) return;
            
            // Remove if already exists
            searchHistory = searchHistory.filter(item => item !== term.trim());
            
            // Add to beginning
            searchHistory.unshift(term.trim());
            
            // Keep only last 10 items
            if (searchHistory.length > 10) {
                searchHistory = searchHistory.slice(0, 10);
            }
            
            // Save and update display
            saveSearchHistory();
            displaySearchHistory();
        }
        
        // Display search history
        function displaySearchHistory() {
            searchHistoryList.innerHTML = '';
            
            if (searchHistory.length === 0) {
                searchHistoryList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #888; font-style: italic;">
                        No recent searches
                    </div>
                `;
                return;
            }
            
            searchHistory.forEach(term => {
                const historyItem = document.createElement('div');
                historyItem.className = 'search-history-item';
                historyItem.innerHTML = `
                    <i class="fas fa-clock search-history-icon"></i>
                    <div class="search-history-text">${term}</div>
                    <button class="clear-history-btn remove-history-btn" data-term="${term}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                historyItem.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('remove-history-btn')) {
                        searchBar.value = term;
                        performSearch(term);
                    }
                });
                
                const removeBtn = historyItem.querySelector('.remove-history-btn');
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    removeFromSearchHistory(term);
                });
                
                searchHistoryList.appendChild(historyItem);
            });
        }
        
        // Remove term from search history
        function removeFromSearchHistory(term) {
            searchHistory = searchHistory.filter(item => item !== term);
            saveSearchHistory();
            displaySearchHistory();
        }
        
        // Clear all search history
        function clearSearchHistory() {
            searchHistory = [];
            saveSearchHistory();
            displaySearchHistory();
            showNotification('History Cleared', 'Search history has been cleared');
        }
        
        // Load cache from localStorage
        function loadCacheFromStorage() {
            try {
                const cache = localStorage.getItem('edirear_channel_cache');
                if (cache) {
                    channelLogoCache = JSON.parse(cache);
                }
                
                const videosCache = localStorage.getItem('edirear_videos_cache');
                if (videosCache) {
                    channelVideosCache = JSON.parse(videosCache);
                }
            } catch (error) {
                console.error('Error loading cache:', error);
                channelLogoCache = {};
                channelVideosCache = {};
            }
        }
        
        // Save cache to localStorage
        function saveCacheToStorage() {
            try {
                localStorage.setItem('edirear_channel_cache', JSON.stringify(channelLogoCache));
                localStorage.setItem('edirear_videos_cache', JSON.stringify(channelVideosCache));
            } catch (error) {
                console.error('Error saving cache:', error);
            }
        }
        
        // Get channel logo with caching
        function getChannelLogo(channelId, channelName) {
            // Check cache first
            if (channelLogoCache[channelId]) {
                return channelLogoCache[channelId];
            }
            
            // Generate and cache logo
            const firstLetter = channelName.charAt(0).toUpperCase();
            const colors = ['#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#EF476F', '#073B4C'];
            const colorIndex = channelId.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0) % colors.length;
            const bgColor = colors[colorIndex];
            
            // Create a canvas for the logo
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            // Draw background
            ctx.fillStyle = bgColor;
            ctx.beginPath();
            ctx.arc(50, 50, 50, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw text
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(firstLetter, 50, 50);
            
            const logoUrl = canvas.toDataURL();
            
            // Cache the logo
            channelLogoCache[channelId] = logoUrl;
            saveCacheToStorage();
            
            return logoUrl;
        }
        
        // Initialize Google OAuth2 Client
        function initializeGoogleOAuth() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/youtube.force-ssl https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtubepartner',
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        accessToken = tokenResponse.access_token;
                        tokenExpiry = Date.now() + (tokenResponse.expires_in * 1000);
                        
                        // Get user info
                        getUserInfo(accessToken);
                        
                        showNotification('Sign In Successful', 'You can now like, subscribe, and save videos!');
                    }
                },
                error_callback: (error) => {
                    console.error('Google OAuth Error:', error);
                    if (error.type === 'user_logged_out') {
                        showNotification('Sign In Required', 'Please sign in to perform YouTube actions.');
                    } else if (error.type === 'access_denied') {
                        showNotification('Permission Denied', 'YouTube permissions are required to like, subscribe, and save videos.');
                    }
                }
            });
        }
        
        // Get user info from Google API
        function getUserInfo(token) {
            fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to get user info');
                }
                return response.json();
            })
            .then(userInfo => {
                googleUser = userInfo;
                isSignedIn = true;
                
                // Save auth data for cross-domain access
                saveAuthDataForCrossDomain();
                
                // Also save in old format for backward compatibility
                localStorage.setItem('edirear_user', JSON.stringify(googleUser));
                localStorage.setItem('edirear_access_token', accessToken);
                localStorage.setItem('edirear_token_expiry', tokenExpiry);
                
                // Update UI
                showApp();
                updateUIForSignedInUser();
                
                // Load subscriptions if user is signed in
                loadSubscriptions();
            })
            .catch(error => {
                console.error('Error fetching user info:', error);
                showNotification('Sign In Error', 'Failed to get user information. Please try again.');
            });
        }
        
        // Update UI for signed-in user
        function updateUIForSignedInUser() {
            if (googleUser) {
                userAvatar.src = googleUser.picture || 'https://via.placeholder.com/40/333/fff?text=U';
                userName.textContent = googleUser.name || 'User';
                userProfile.style.display = 'flex';
                googleSignInHeader.style.display = 'none';
                uploadIcon.style.display = 'block';
                
                // Enable YouTube action buttons
                updateSubscribeButtonVisibility(true);
                likeBtn.disabled = false;
                likeBtn.style.cursor = 'pointer';
                likeBtn.style.opacity = '1';
                addToPlaylistBtn.disabled = false;
                addToPlaylistBtn.style.cursor = 'pointer';
                addToPlaylistBtn.style.opacity = '1';
                shareBtn.disabled = false;
                shareBtn.style.cursor = 'pointer';
                shareBtn.style.opacity = '1';
            }
        }
        
        // Initialize Firebase Messaging for notifications
        function initFirebaseMessaging() {
            Notification.requestPermission().then((permission) => {
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                    
                    // Get FCM token
                    messaging.getToken({ vapidKey: VAPID_KEY }).then((currentToken) => {
                        if (currentToken) {
                            console.log('FCM token:', currentToken);
                            localStorage.setItem('fcm_token', currentToken);
                        } else {
                            console.log('No registration token available. Request permission to generate one.');
                        }
                    }).catch((err) => {
                        console.log('An error occurred while retrieving token. ', err);
                    });
                } else {
                    console.log('Unable to get permission to notify.');
                }
            });
            
            // Handle incoming messages
            messaging.onMessage((payload) => {
                console.log('Message received. ', payload);
                showNotification(payload.notification.title, payload.notification.body);
            });
        }
        
        // Show notification function
        function showNotification(title, message, duration = 5000) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-play-circle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Auto remove after duration
            const timeout = setTimeout(() => {
                closeNotification(notification);
            }, duration);
            
            // Close on button click
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                clearTimeout(timeout);
                closeNotification(notification);
            });
        }
        
        // Close notification with animation
        function closeNotification(notification) {
            notification.classList.add('hiding');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
        
        // Show welcome notification when app is opened
        function showWelcomeNotification() {
            if (!sessionStorage.getItem('welcomeShown')) {
                setTimeout(() => {
                    showNotification('Welcome to Edirear', 'Enjoy the media. Sign in with Google to subscribe to channels!');
                    sessionStorage.setItem('welcomeShown', 'true');
                }, 1000);
            }
        }
        
        // Check if user is already authenticated
        function checkAuthStatus() {
            // First try to load from the new cross-domain storage format
            if (loadAuthDataFromStorage()) {
                // Auth data loaded successfully
                showApp();
                return;
            }
            
            // Fallback to old localStorage format
            const savedUser = localStorage.getItem('edirear_user');
            const savedToken = localStorage.getItem('edirear_access_token');
            const savedTokenExpiry = localStorage.getItem('edirear_token_expiry');
            
            if (savedUser && savedToken && savedTokenExpiry) {
                googleUser = JSON.parse(savedUser);
                accessToken = savedToken;
                tokenExpiry = parseInt(savedTokenExpiry);
                isSignedIn = true;
                
                // Check if token is still valid
                if (Date.now() >= tokenExpiry) {
                    // Token expired, need to refresh
                    clearAuthData();
                    
                    // Show login screen
                    showLoginScreen();
                    showNotification('Session Expired', 'Please sign in again to continue.');
                } else {
                    // Token is valid, migrate to new format
                    saveAuthDataForCrossDomain();
                    showApp();
                }
            } else {
                // Show login screen
                showLoginScreen();
            }
        }
        
        // Show login screen
        function showLoginScreen() {
            welcomeScreen.style.display = 'none';
            countryScreen.style.display = 'none';
            contentSetupScreen.style.display = 'none';
            searchPage.style.display = 'none';
            followingPage.style.display = 'none';
            loginScreen.style.display = 'flex';
        }
        
        // Show country selection screen
        function showCountrySelection() {
            welcomeScreen.style.display = 'none';
            loginScreen.style.display = 'none';
            searchPage.style.display = 'none';
            followingPage.style.display = 'none';
            countryScreen.style.display = 'flex';
        }
        
        // Show search page
        function showSearchPage() {
            welcomeScreen.style.display = 'none';
            loginScreen.style.display = 'none';
            countryScreen.style.display = 'none';
            contentSetupScreen.style.display = 'none';
            appContainer.style.display = 'none';
            channelPage.style.display = 'none';
            followingPage.style.display = 'none';
            searchPage.style.display = 'block';
            
            // Show search history initially
            searchHistoryContainer.style.display = 'block';
            searchResultsContainer.style.display = 'none';
            
            // Focus on search bar
            setTimeout(() => {
                searchBar.focus();
            }, 100);
        }
        
        // Show following page
        function showFollowingPage() {
            welcomeScreen.style.display = 'none';
            loginScreen.style.display = 'none';
            countryScreen.style.display = 'none';
            contentSetupScreen.style.display = 'none';
            appContainer.style.display = 'none';
            channelPage.style.display = 'none';
            searchPage.style.display = 'none';
            followingPage.style.display = 'block';
            
            // Load subscriptions if user is signed in
            if (isSignedIn) {
                loadSubscriptions();
            } else {
                showNoSubscriptionsMessage();
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Get Started button
            getStartedBtn.addEventListener('click', function() {
                welcomeScreen.style.display = 'none';
                showCountrySelection();
            });
            
            // Country selection
            saveCountryBtn.addEventListener('click', handleCountrySelection);
            
            // Google Sign-In button
            googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            googleSignInHeader.addEventListener('click', handleGoogleSignIn);
            
            // Continue without sign in button
            continueWithoutSignInBtn.addEventListener('click', function() {
                isSignedIn = false;
                showApp();
            });
            
            // Sign out button (from user profile)
            signOutBtn.addEventListener('click', handleSignOut);
            
            // Settings sign out button
            settingsSignOutBtn.addEventListener('click', function() {
                settingsModal.style.display = 'none';
                contactOptions.style.display = 'none';
                emailDisplay.style.display = 'none';
                handleSignOut();
            });
            
            // Home logo click
            homeLogo.addEventListener('click', function() {
                // If on channel page, go back to home
                if (channelPage.style.display === 'block') {
                    channelPage.style.display = 'none';
                    appContainer.style.display = 'block';
                }
            });
            
            // Content setup
            addContentBtn.addEventListener('click', addContentTag);
            contentInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addContentTag();
                }
            });
            skipSetupBtn.addEventListener('click', function() {
                userInterests = [];
                localStorage.setItem('edirear_interests', JSON.stringify(userInterests));
                localStorage.setItem('edirear_preferences_set', 'true');
                showApp();
            });
            doneSetupBtn.addEventListener('click', function() {
                localStorage.setItem('edirear_interests', JSON.stringify(userInterests));
                localStorage.setItem('edirear_preferences_set', 'true');
                showApp();
            });
            
            // Settings icon click
            settingsIcon.addEventListener('click', function() {
                settingsModal.style.display = 'block';
            });
            
            // Close settings modal
            closeSettingsModal.addEventListener('click', function() {
                settingsModal.style.display = 'none';
                contactOptions.style.display = 'none';
                emailDisplay.style.display = 'none';
            });
            
            // Privacy Policy button
            privacyPolicyBtn.addEventListener('click', function() {
                window.location.href = 'https://edirearhelp.github.io/privacypolicy';
            });
            
            // Contact Us button
            contactUsBtn.addEventListener('click', function() {
                contactOptions.style.display = 'flex';
                emailDisplay.style.display = 'none';
            });
            
            // Edirear Studio button
            edirearStudioBtn.addEventListener('click', function() {
                window.location.href = 'https://edirearhelp.github.io/studio';
            });
            
            // Premium button
            premiumBtn.addEventListener('click', function() {
                window.location.href = 'https://edirearhelp.github.io/pre';
            });
            
            // Game button
            gameBtn.addEventListener('click', function() {
                window.location.href = 'https://edirearhelp.github.io/game';
            });
            
            // WhatsApp option
            whatsappOption.addEventListener('click', function() {
                window.open('https://wa.me/03264423420', '_blank');
            });
            
            // Email option
            emailOption.addEventListener('click', function() {
                contactOptions.style.display = 'none';
                emailDisplay.style.display = 'block';
            });
            
            // Copy Email button
            copyEmailBtn.addEventListener('click', function() {
                navigator.clipboard.writeText('edirearhelp@gmail.com').then(function() {
                    showNotification('Email Copied', 'Email address copied to clipboard');
                }, function(err) {
                    console.error('Could not copy text: ', err);
                });
            });
            
            // Category selection
            categoryItems.forEach(item => {
                item.addEventListener('click', function() {
                    categoryItems.forEach(cat => cat.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.getAttribute('data-category');
                    loadVideosByCategory(currentCategory);
                });
            });
            
            // Close modal when clicking X
            closeModal.addEventListener('click', function() {
                videoModal.style.display = 'none';
                if (player) {
                    player.destroy();
                    player = null;
                }
                shareMenu.style.display = 'none';
                isShortsPlaying = false;
                shortsVideoId = null;
                
                // Hide ad banner
                adBannerContainer.style.display = 'none';
                
                // Clear comment interval
                if (commentInterval) {
                    clearInterval(commentInterval);
                    commentInterval = null;
                }
                
                // Clear player interval
                if (playerInterval) {
                    clearInterval(playerInterval);
                    playerInterval = null;
                }
                
                // Save playback position before closing
                saveCurrentPlaybackPosition();
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === videoModal) {
                    videoModal.style.display = 'none';
                    if (player) {
                        player.destroy();
                        player = null;
                    }
                    shareMenu.style.display = 'none';
                    isShortsPlaying = false;
                    shortsVideoId = null;
                    
                    // Hide ad banner
                    adBannerContainer.style.display = 'none';
                    
                    // Clear comment interval
                    if (commentInterval) {
                        clearInterval(commentInterval);
                        commentInterval = null;
                    }
                    
                    // Clear player interval
                    if (playerInterval) {
                        clearInterval(playerInterval);
                        playerInterval = null;
                    }
                    
                    // Save playback position before closing
                    saveCurrentPlaybackPosition();
                }
                if (event.target === settingsModal) {
                    settingsModal.style.display = 'none';
                    contactOptions.style.display = 'none';
                    emailDisplay.style.display = 'none';
                }
                if (event.target === searchPage) {
                    searchSuggestions.style.display = 'none';
                }
            });
            
            // Menu icon click
            menuIcon.addEventListener('click', function() {
                window.location.href = 'https://edirearhelp.github.io/menu';
            });
            
            // Search icon click (top)
            searchIconTop.addEventListener('click', function() {
                showSearchPage();
            });
            
            // Bottom navigation clicks
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    navigateToPage(page);
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Back to home button (from channel page)
            backToHome.addEventListener('click', function() {
                channelPage.style.display = 'none';
                appContainer.style.display = 'block';
            });
            
            // Back to home from search page
            backToHomeSearch.addEventListener('click', function() {
                searchPage.style.display = 'none';
                appContainer.style.display = 'block';
            });
            
            // Back to home from following page
            backToHomeFollowing.addEventListener('click', function() {
                followingPage.style.display = 'none';
                appContainer.style.display = 'block';
            });
            
            // Channel tab clicks
            channelTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Update active tab
                    channelTabs.forEach(t => {
                        t.classList.remove('active');
                        document.getElementById(`${t.getAttribute('data-tab')}Tab`).style.display = 'none';
                    });
                    this.classList.add('active');
                    document.getElementById(`${tabName}Tab`).style.display = 'block';
                    
                    // Load tab content if needed
                    if (tabName === 'videos' && channelVideosGrid.children.length === 0) {
                        loadChannelVideos();
                    } else if (tabName === 'shorts' && channelShortsGrid.children.length === 0) {
                        loadChannelShorts();
                    } else if (tabName === 'posts' && channelPostsGrid.children.length === 0) {
                        loadChannelPosts();
                    }
                });
            });
            
            // Channel subscribe button
            channelSubscribeBtn.addEventListener('click', toggleChannelSubscription);
            modalSubscribeBtn.addEventListener('click', toggleChannelSubscription);
            
            // Channel info modal click (to open channel page)
            channelInfoModal.addEventListener('click', function(e) {
                if (!e.target.closest('.subscribe-btn')) {
                    if (currentVideo && currentVideo.snippet) {
                        openChannelPage(currentVideo.snippet.channelId, currentVideo.snippet.channelTitle);
                    }
                }
            });
            
            // Video actions event listeners
            likeBtn.addEventListener('click', toggleLikeVideo);
            addToPlaylistBtn.addEventListener('click', addVideoToPlaylist);
            shareBtn.addEventListener('click', toggleShareMenu);
            
            // Share options
            whatsappShare.addEventListener('click', function() {
                shareVideo('whatsapp');
            });
            facebookShare.addEventListener('click', function() {
                shareVideo('facebook');
            });
            twitterShare.addEventListener('click', function() {
                shareVideo('twitter');
            });
            telegramShare.addEventListener('click', function() {
                shareVideo('telegram');
            });
            copyLinkBtn.addEventListener('click', copyVideoLink);
            
            // Show more/less button for description
            showMoreBtn.addEventListener('click', function() {
                const isExpanded = videoDescription.classList.contains('expanded');
                if (isExpanded) {
                    videoDescription.classList.remove('expanded');
                    showMoreBtn.textContent = 'Show more';
                } else {
                    videoDescription.classList.add('expanded');
                    showMoreBtn.textContent = 'Show less';
                }
            });
            
            // Channel show more button
            channelShowMoreBtn.addEventListener('click', function() {
                const isExpanded = channelDescriptionText.classList.contains('expanded');
                if (isExpanded) {
                    channelDescriptionText.classList.remove('expanded');
                    channelShowMoreBtn.textContent = 'Show more';
                } else {
                    channelDescriptionText.classList.add('expanded');
                    channelShowMoreBtn.textContent = 'Show less';
                }
            });
            
            // Comments event listeners
            commentInput.addEventListener('input', function() {
                postCommentBtn.disabled = this.value.trim() === '' || !isSignedIn;
            });
            
            postCommentBtn.addEventListener('click', postComment);
            
            commentInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    postComment();
                }
            });
            
            // Close share menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!shareBtn.contains(event.target) && !shareMenu.contains(event.target)) {
                    shareMenu.style.display = 'none';
                }
            });
            
            // Search functionality event listeners
            searchBar.addEventListener('input', handleSearchInput);
            searchBar.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch(searchBar.value.trim());
                }
            });
            searchButton.addEventListener('click', function() {
                performSearch(searchBar.value.trim());
            });
            
            clearHistoryBtn.addEventListener('click', clearSearchHistory);
            searchLoadMoreBtn.addEventListener('click', loadMoreSearchResults);
            
            // Close search suggestions when clicking outside
            document.addEventListener('click', function(event) {
                if (!searchBar.contains(event.target) && !searchSuggestions.contains(event.target) && !searchButton.contains(event.target)) {
                    searchSuggestions.style.display = 'none';
                }
            });
            
            // Preferences icon click
            preferencesIcon.addEventListener('click', function() {
                openPreferencesModal();
            });
            
            // Preferences button click
            preferencesButton.addEventListener('click', function() {
                openPreferencesModal();
            });
            
            // Close preferences modal
            closePreferencesModal.addEventListener('click', function() {
                preferencesModal.style.display = 'none';
            });
            
            // Cancel preferences button
            cancelPreferencesBtn.addEventListener('click', function() {
                preferencesModal.style.display = 'none';
            });
            
            // Save preferences button
            savePreferencesBtn.addEventListener('click', function() {
                savePreferences();
            });
            
            // Add preferences tag
            addPreferencesBtn.addEventListener('click', addPreferencesTag);
            preferencesInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addPreferencesTag();
                }
            });
            
            // Upload icon click
            uploadIcon.addEventListener('click', function() {
                uploadModal.style.display = 'block';
            });
            
            // Close upload modal
            closeUploadModal.addEventListener('click', function() {
                uploadModal.style.display = 'none';
            });
            
            // Cancel upload
            cancelUpload.addEventListener('click', function() {
                uploadModal.style.display = 'none';
            });
            
            // Upload form submission
            uploadForm.addEventListener('submit', handleVideoUpload);
            
            // Thumbnail preview
            videoThumbnail.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        thumbnailPreview.src = e.target.result;
                        thumbnailPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    thumbnailPreview.style.display = 'none';
                }
            });
            
            // Resume playback event listeners
            resumePlaybackBtn.addEventListener('click', resumePlayback);
            closeResumeNotification.addEventListener('click', hideResumePlaybackNotification);
            
            // Save playback position when user leaves the page
            window.addEventListener('beforeunload', function() {
                saveCurrentPlaybackPosition();
            });
            
            // Save playback position when page becomes hidden (tab switched, minimized, etc.)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    saveCurrentPlaybackPosition();
                }
            });
        }
        
        // Handle search input for suggestions
        function handleSearchInput() {
            const query = searchBar.value.trim();
            
            // Clear previous timeout
            if (searchSuggestionsTimeout) {
                clearTimeout(searchSuggestionsTimeout);
            }
            
            if (!query) {
                searchSuggestions.style.display = 'none';
                return;
            }
            
            // Set timeout to delay API call
            searchSuggestionsTimeout = setTimeout(() => {
                fetchSearchSuggestions(query);
            }, 300);
        }
        
        // Fetch search suggestions from YouTube API
        async function fetchSearchSuggestions(query) {
            if (!query || query.length < 2) {
                searchSuggestions.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(
                    `https://suggestqueries.google.com/complete/search?client=firefox&ds=yt&q=${encodeURIComponent(query)}`
                );
                
                if (!response.ok) {
                    throw new Error('Failed to fetch suggestions');
                }
                
                const text = await response.text();
                // Parse the JSONP response
                const jsonpData = text.replace(/^window\.google\.ac\.h\(/, '').replace(/\)$/, '');
                const data = JSON.parse(jsonpData);
                
                if (data && data[1] && data[1].length > 0) {
                    displaySearchSuggestions(data[1], query);
                } else {
                    searchSuggestions.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching search suggestions:', error);
                searchSuggestions.style.display = 'none';
            }
        }
        
        // Display search suggestions
        function displaySearchSuggestions(suggestions, query) {
            searchSuggestions.innerHTML = '';
            
            // Filter and limit suggestions
            const filteredSuggestions = suggestions
                .filter(suggestion => suggestion.toLowerCase().includes(query.toLowerCase()))
                .slice(0, 8);
            
            if (filteredSuggestions.length === 0) {
                searchSuggestions.style.display = 'none';
                return;
            }
            
            filteredSuggestions.forEach(suggestion => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'search-suggestion-item';
                
                // Highlight the matching part
                const lowerSuggestion = suggestion.toLowerCase();
                const lowerQuery = query.toLowerCase();
                const matchIndex = lowerSuggestion.indexOf(lowerQuery);
                
                let displayText = suggestion;
                if (matchIndex !== -1) {
                    const beforeMatch = suggestion.substring(0, matchIndex);
                    const match = suggestion.substring(matchIndex, matchIndex + query.length);
                    const afterMatch = suggestion.substring(matchIndex + query.length);
                    displayText = `${beforeMatch}<strong>${match}</strong>${afterMatch}`;
                }
                
                suggestionItem.innerHTML = `
                    <div class="search-suggestion-text">${displayText}</div>
                `;
                
                suggestionItem.addEventListener('click', function() {
                    searchBar.value = suggestion;
                    performSearch(suggestion);
                });
                
                searchSuggestions.appendChild(suggestionItem);
            });
            
            searchSuggestions.style.display = 'block';
        }
        
        // Perform search
        async function performSearch(query) {
            if (!query.trim()) {
                showNotification('Search Error', 'Please enter a search term');
                return;
            }
            
            currentSearchTerm = query.trim();
            searchApiKeyIndex = 0;
            searchNextPageToken = null;
            isSearchLoadingMore = false;
            
            // Add to search history
            addToSearchHistory(currentSearchTerm);
            
            // Hide suggestions
            searchSuggestions.style.display = 'none';
            
            // Show loading state
            searchHistoryContainer.style.display = 'none';
            searchResultsContainer.style.display = 'block';
            searchVideoFeed.innerHTML = `
                <div class="loading" style="grid-column: 1/-1;">
                    <div class="spinner"></div>
                    <div>Searching for "${currentSearchTerm}"...</div>
                </div>
            `;
            searchLoadMoreContainer.style.display = 'none';
            
            // Update results title
            searchResultsTitle.textContent = `Search results for "${currentSearchTerm}"`;
            
            try {
                await fetchSearchResults(currentSearchTerm, true);
            } catch (error) {
                console.error('Error performing search:', error);
                searchVideoFeed.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3>Failed to search</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 15px; font-size: 14px; opacity: 0.7;">
                            Please check your connection and try again later.
                        </p>
                    </div>
                `;
            }
        }
        
        // Fetch search results from YouTube API
        async function fetchSearchResults(query, isInitial = false) {
            try {
                if (isInitial) {
                    searchNextPageToken = null;
                    searchApiKeyIndex = 0;
                }
                
                const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=10&key=${SEARCH_API_KEYS[searchApiKeyIndex]}`;
                
                const finalUrl = searchNextPageToken ? `${searchUrl}&pageToken=${searchNextPageToken}` : searchUrl;
                
                const searchResponse = await fetch(finalUrl);
                
                if (!searchResponse.ok) {
                    // Try next API key if current one fails
                    if (searchApiKeyIndex < SEARCH_API_KEYS.length - 1) {
                        searchApiKeyIndex++;
                        return fetchSearchResults(query, isInitial);
                    }
                    throw new Error(`YouTube API error: ${searchResponse.status}`);
                }
                
                const searchData = await searchResponse.json();
                const videoIds = searchData.items.map(item => item.id.videoId);
                searchNextPageToken = searchData.nextPageToken || null;
                
                if (videoIds.length > 0) {
                    // Fetch video details
                    const videosResponse = await fetch(
                        `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoIds.join(',')}&key=${SEARCH_API_KEYS[searchApiKeyIndex]}`
                    );
                    
                    if (videosResponse.ok) {
                        const videosData = await videosResponse.json();
                        const regularVideos = videosData.items.filter(video => {
                            return !isShortVideo(video);
                        });
                        
                        if (isInitial) {
                            displaySearchResults(regularVideos);
                        } else {
                            appendSearchResults(regularVideos);
                        }
                        
                        // Show load more button if there are more results
                        if (searchNextPageToken) {
                            searchLoadMoreContainer.style.display = 'flex';
                        } else {
                            searchLoadMoreContainer.style.display = 'none';
                        }
                    }
                } else {
                    // No results found
                    if (isInitial) {
                        searchVideoFeed.innerHTML = `
                            <div class="no-search-results">
                                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px;"></i>
                                <div>No results found for "${query}"</div>
                                <p style="margin-top: 15px; font-size: 14px; opacity: 0.7;">
                                    Try different keywords or check your spelling.
                                </p>
                            </div>
                        `;
                    } else {
                        showNotification('No More Results', 'No more search results available');
                        searchLoadMoreContainer.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Error fetching search results:', error);
                throw error;
            }
        }
        
        // Display search results
        function displaySearchResults(videos) {
            searchVideoFeed.innerHTML = '';
            
            if (videos.length === 0) {
                searchVideoFeed.innerHTML = `
                    <div class="no-search-results">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <div>No results found</div>
                    </div>
                `;
                return;
            }
            
            videos.forEach(video => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                videoItem.setAttribute('data-video-id', video.id);
                
                // Use high-quality thumbnail
                const thumbnailUrl = video.snippet.thumbnails.maxres?.url || 
                                   video.snippet.thumbnails.high?.url || 
                                   video.snippet.thumbnails.medium?.url || 
                                   video.snippet.thumbnails.default?.url;
                const title = video.snippet.title;
                const channel = video.snippet.channelTitle;
                const views = formatNumber(video.statistics?.viewCount || '0');
                const publishedAt = formatTimeAgo(video.snippet.publishedAt);
                const duration = formatDuration(parseDuration(video.contentDetails?.duration || 'PT0S'));
                
                // Get or generate channel logo
                const channelId = video.snippet.channelId;
                const channelLogo = getChannelLogo(channelId, channel);
                
                videoItem.innerHTML = `
                    <div class="video-thumbnail-container">
                        <img src="${thumbnailUrl}" alt="${title}" class="video-thumbnail high-quality-thumbnail" loading="lazy">
                        <div class="video-duration">${duration}</div>
                    </div>
                    <div class="video-info">
                        <div class="video-title">${title}</div>
                        <div class="video-channel-info" data-channel-id="${channelId}" data-channel-name="${channel}">
                            <img src="${channelLogo}" alt="${channel}" class="channel-logo-small channel-logo-cached">
                            <div class="video-channel">${channel}</div>
                        </div>
                        <div class="video-metadata">
                            <span>${views} views</span>
                            <span></span>
                            <span>${publishedAt}</span>
                        </div>
                    </div>
                `;
                
                videoItem.addEventListener('click', function() {
                    // Hide search page
                    searchPage.style.display = 'none';
                    searchSuggestions.style.display = 'none';
                    
                    // Show app container
                    appContainer.style.display = 'block';
                    
                    // Open video modal after a short delay
                    setTimeout(() => {
                        openVideoModal(video);
                    }, 100);
                });
                
                // Add click event to channel info
                const channelInfo = videoItem.querySelector('.video-channel-info');
                channelInfo.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const channelId = this.getAttribute('data-channel-id');
                    const channelName = this.getAttribute('data-channel-name');
                    
                    // Hide search page
                    searchPage.style.display = 'none';
                    searchSuggestions.style.display = 'none';
                    
                    // Show app container
                    appContainer.style.display = 'block';
                    
                    // Open channel page after a short delay
                    setTimeout(() => {
                        openChannelPage(channelId, channelName);
                    }, 100);
                });
                
                searchVideoFeed.appendChild(videoItem);
            });
        }
        
        // Append more search results
        function appendSearchResults(videos) {
            if (videos.length === 0) {
                showNotification('No More Results', 'No more search results available');
                return;
            }
            
            videos.forEach(video => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                videoItem.setAttribute('data-video-id', video.id);
                
                // Use high-quality thumbnail
                const thumbnailUrl = video.snippet.thumbnails.maxres?.url || 
                                   video.snippet.thumbnails.high?.url || 
                                   video.snippet.thumbnails.medium?.url || 
                                   video.snippet.thumbnails.default?.url;
                const title = video.snippet.title;
                const channel = video.snippet.channelTitle;
                const views = formatNumber(video.statistics?.viewCount || '0');
                const publishedAt = formatTimeAgo(video.snippet.publishedAt);
                const duration = formatDuration(parseDuration(video.contentDetails?.duration || 'PT0S'));
                
                // Get or generate channel logo
                const channelId = video.snippet.channelId;
                const channelLogo = getChannelLogo(channelId, channel);
                
                videoItem.innerHTML = `
                    <div class="video-thumbnail-container">
                        <img src="${thumbnailUrl}" alt="${title}" class="video-thumbnail high-quality-thumbnail" loading="lazy">
                        <div class="video-duration">${duration}</div>
                    </div>
                    <div class="video-info">
                        <div class="video-title">${title}</div>
                        <div class="video-channel-info" data-channel-id="${channelId}" data-channel-name="${channel}">
                            <img src="${channelLogo}" alt="${channel}" class="channel-logo-small channel-logo-cached">
                            <div class="video-channel">${channel}</div>
                        </div>
                        <div class="video-metadata">
                            <span>${views} views</span>
                            <span></span>
                            <span>${publishedAt}</span>
                        </div>
                    </div>
                `;
                
                videoItem.addEventListener('click', function() {
                    // Hide search page
                    searchPage.style.display = 'none';
                    searchSuggestions.style.display = 'none';
                    
                    // Show app container
                    appContainer.style.display = 'block';
                    
                    // Open video modal after a short delay
                    setTimeout(() => {
                        openVideoModal(video);
                    }, 100);
                });
                
                // Add click event to channel info
                const channelInfo = videoItem.querySelector('.video-channel-info');
                channelInfo.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const channelId = this.getAttribute('data-channel-id');
                    const channelName = this.getAttribute('data-channel-name');
                    
                    // Hide search page
                    searchPage.style.display = 'none';
                    searchSuggestions.style.display = 'none';
                    
                    // Show app container
                    appContainer.style.display = 'block';
                    
                    // Open channel page after a short delay
                    setTimeout(() => {
                        openChannelPage(channelId, channelName);
                    }, 100);
                });
                
                searchVideoFeed.appendChild(videoItem);
            });
        }
        
        // Load more search results
        async function loadMoreSearchResults() {
            if (isSearchLoadingMore) return;
            
            isSearchLoadingMore = true;
            
            try {
                searchLoadMoreBtn.disabled = true;
                searchLoadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                
                await fetchSearchResults(currentSearchTerm, false);
                
            } catch (error) {
                console.error('Error loading more search results:', error);
                showNotification('Load Failed', 'Failed to load more results. Please try again.');
            } finally {
                isSearchLoadingMore = false;
                searchLoadMoreBtn.disabled = false;
                searchLoadMoreBtn.innerHTML = '<i class="fas fa-plus"></i> Load More Videos';
            }
        }
        
        // Handle country selection
        function handleCountrySelection() {
            const country = countrySelect.value;
            if (country) {
                userCountry = country;
                localStorage.setItem('edirear_user_country', userCountry);
                
                // Check if user has preferences already
                const hasSetPreferences = localStorage.getItem('edirear_preferences_set');
                if (hasSetPreferences || userInterests.length > 0) {
                    showLoginScreen();
                } else {
                    showContentSetup();
                }
                
                showNotification('Country Selected', `You've selected ${countrySelect.options[countrySelect.selectedIndex].text}`);
            } else {
                showNotification('Country Required', 'Please select your country to continue.');
            }
        }
        
        // Handle Google Sign-In
        function handleGoogleSignIn() {
            if (!tokenClient) {
                initializeGoogleOAuth();
            }
            
            // Request access token
            tokenClient.requestAccessToken();
        }
        
        // Handle sign out
        function handleSignOut() {
            if (accessToken) {
                // Revoke the access token
                google.accounts.oauth2.revoke(accessToken, () => {
                    console.log('Access token revoked');
                });
            }
            
            // Clear all stored data
            clearAuthData();
            
            googleUser = null;
            accessToken = null;
            isSignedIn = false;
            
            // Reset UI
            showLoginScreen();
            appContainer.style.display = 'none';
            contentSetupScreen.style.display = 'none';
            channelPage.style.display = 'none';
            searchPage.style.display = 'none';
            followingPage.style.display = 'none';
            
            // Clear comment interval
            if (commentInterval) {
                clearInterval(commentInterval);
                commentInterval = null;
            }
            
            // Clear player interval
            if (playerInterval) {
                clearInterval(playerInterval);
                playerInterval = null;
            }
            
            // Clear player
            if (player) {
                player.destroy();
                player = null;
            }
            
            showNotification('Signed Out', 'You have been signed out successfully.');
        }
        
        // Get valid access token (check expiry and refresh if needed)
        async function getValidAccessToken() {
            if (!accessToken) {
                throw new Error('No access token available. Please sign in.');
            }
            
            // Check if token is about to expire (within 5 minutes)
            if (Date.now() >= tokenExpiry - 300000) {
                try {
                    await refreshAccessToken();
                } catch (error) {
                    console.error('Failed to refresh token:', error);
                    showNotification('Session Expired', 'Please sign in again.');
                    handleSignOut();
                    throw new Error('Token expired and refresh failed');
                }
            }
            
            return accessToken;
        }
        
        // Refresh access token
        async function refreshAccessToken() {
            // Note: The Google Identity Services library handles token refresh automatically
            // We just need to ensure we're using the latest token
            showNotification('Refreshing Session', 'Your session is being refreshed...');
            
            // For now, we'll ask the user to sign in again if token expires
            // In production, you would implement proper token refresh logic
            throw new Error('Token refresh required - please sign in again');
        }
        
        // Add content tag
        function addContentTag() {
            const content = contentInput.value.trim();
            if (content && !userInterests.includes(content)) {
                userInterests.push(content);
                renderContentTags();
                contentInput.value = '';
            }
        }
        
        // Remove content tag
        function removeContentTag(index) {
            userInterests.splice(index, 1);
            renderContentTags();
        }
        
        // Render content tags
        function renderContentTags() {
            contentTags.innerHTML = '';
            userInterests.forEach((interest, index) => {
                const tag = document.createElement('div');
                tag.className = 'content-tag';
                tag.innerHTML = `
                    <span>${interest}</span>
                    <button class="remove-tag" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                contentTags.appendChild(tag);
            });
            
            document.querySelectorAll('.remove-tag').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removeContentTag(index);
                });
            });
        }
        
        // Add preferences tag
        function addPreferencesTag() {
            const content = preferencesInput.value.trim();
            if (content && !userInterests.includes(content)) {
                userInterests.push(content);
                renderPreferencesTags();
                preferencesInput.value = '';
            }
        }
        
        // Remove preferences tag
        function removePreferencesTag(index) {
            userInterests.splice(index, 1);
            renderPreferencesTags();
        }
        
        // Render preferences tags
        function renderPreferencesTags() {
            preferencesTags.innerHTML = '';
            userInterests.forEach((interest, index) => {
                const tag = document.createElement('div');
                tag.className = 'content-tag';
                tag.innerHTML = `
                    <span>${interest}</span>
                    <button class="remove-tag" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                preferencesTags.appendChild(tag);
            });
            
            document.querySelectorAll('#preferencesTags .remove-tag').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removePreferencesTag(index);
                });
            });
        }
        
        // Show content setup screen
        function showContentSetup() {
            loginScreen.style.display = 'none';
            countryScreen.style.display = 'none';
            contentSetupScreen.style.display = 'flex';
            renderContentTags();
        }
        
        // Open preferences modal
        function openPreferencesModal() {
            renderPreferencesTags();
            preferencesModal.style.display = 'block';
        }
        
        // Save preferences
        function savePreferences() {
            localStorage.setItem('edirear_interests', JSON.stringify(userInterests));
            localStorage.setItem('edirear_preferences_set', 'true');
            preferencesModal.style.display = 'none';
            loadPersonalizedVideos();
            showNotification('Preferences Updated', 'Your preferences have been updated successfully!');
        }
        
        // Show the main app after successful login or without login
        function showApp() {
            loginScreen.style.display = 'none';
            contentSetupScreen.style.display = 'none';
            appContainer.style.display = 'block';
            channelPage.style.display = 'none';
            searchPage.style.display = 'none';
            followingPage.style.display = 'none';
            
            if (isSignedIn && googleUser) {
                updateUIForSignedInUser();
            } else {
                userProfile.style.display = 'none';
                googleSignInHeader.style.display = 'flex';
                uploadIcon.style.display = 'none';
                
                // Disable YouTube action buttons for non-signed-in users
                updateSubscribeButtonVisibility(false);
                likeBtn.disabled = true;
                likeBtn.style.cursor = 'not-allowed';
                likeBtn.style.opacity = '0.5';
                addToPlaylistBtn.disabled = true;
                addToPlaylistBtn.style.cursor = 'not-allowed';
                addToPlaylistBtn.style.opacity = '0.5';
                shareBtn.disabled = true;
                shareBtn.style.cursor = 'not-allowed';
                shareBtn.style.opacity = '0.5';
                
                // Disable comment input for non-signed-in users
                commentInput.disabled = true;
                commentInput.placeholder = 'Sign in to comment...';
                postCommentBtn.disabled = true;
            }
            
            showWelcomeNotification();
            loadPersonalizedVideos();
        }
        
        // Update subscribe button visibility based on sign-in status
        function updateSubscribeButtonVisibility(isSignedIn) {
            if (isSignedIn) {
                // Enable subscribe buttons
                channelSubscribeBtn.classList.remove('disabled');
                modalSubscribeBtn.classList.remove('disabled');
                channelSubscribeBtn.disabled = false;
                modalSubscribeBtn.disabled = false;
                
                // Enable comment input
                commentInput.disabled = false;
                commentInput.placeholder = 'Add a public comment...';
                postCommentBtn.disabled = commentInput.value.trim() === '';
            } else {
                // Disable subscribe buttons
                channelSubscribeBtn.classList.add('disabled');
                modalSubscribeBtn.classList.add('disabled');
                channelSubscribeBtn.disabled = true;
                modalSubscribeBtn.disabled = true;
                
                // Disable comment input
                commentInput.disabled = true;
                commentInput.placeholder = 'Sign in to comment...';
                postCommentBtn.disabled = true;
            }
        }
        
        // Navigate to different pages
        function navigateToPage(page) {
            switch(page) {
                case 'home':
                    // Already on home page
                    appContainer.style.display = 'block';
                    channelPage.style.display = 'none';
                    searchPage.style.display = 'none';
                    followingPage.style.display = 'none';
                    break;
                case 'shorts':
                    window.location.href = 'https://edirearhelp.github.io/shorts';
                    break;
                case 'search':
                    showSearchPage();
                    break;
                case 'following':
                    showFollowingPage();
                    break;
                case 'you':
                    window.location.href = 'https://edirearhelp.github.io/you';
                    break;
            }
        }
        
        // Load subscriptions
        async function loadSubscriptions() {
            try {
                subscriptionsList.innerHTML = `
                    <div class="subscriptions-loading">
                        <div class="spinner"></div>
                        <div>Loading your subscriptions...</div>
                    </div>
                `;
                
                if (!isSignedIn) {
                    showNoSubscriptionsMessage();
                    return;
                }
                
                const token = await getValidAccessToken();
                
                // Fetch subscriptions from YouTube API
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&mine=true&maxResults=50&key=${SUBSCRIPTION_API_KEY}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.items && data.items.length > 0) {
                        subscriptionsData = data.items;
                        displaySubscriptions(data.items);
                    } else {
                        showNoSubscriptionsMessage();
                    }
                } else {
                    // Fallback to local storage
                    const localSubscriptions = JSON.parse(localStorage.getItem('edirear_subscribed_channels') || '[]');
                    if (localSubscriptions.length > 0) {
                        // We have local subscriptions but need to fetch channel data
                        fetchChannelDataForSubscriptions(localSubscriptions);
                    } else {
                        showNoSubscriptionsMessage();
                    }
                }
                
            } catch (error) {
                console.error('Error loading subscriptions:', error);
                // Fallback to local storage
                const localSubscriptions = JSON.parse(localStorage.getItem('edirear_subscribed_channels') || '[]');
                if (localSubscriptions.length > 0) {
                    // We have local subscriptions but need to fetch channel data
                    fetchChannelDataForSubscriptions(localSubscriptions);
                } else {
                    showNoSubscriptionsMessage();
                }
            }
        }
        
        // Fetch channel data for subscriptions
        async function fetchChannelDataForSubscriptions(channelIds) {
            try {
                // We can only fetch 50 channels at a time
                const batchSize = 50;
                let allChannels = [];
                
                for (let i = 0; i < channelIds.length; i += batchSize) {
                    const batchIds = channelIds.slice(i, i + batchSize);
                    const response = await fetch(
                        `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${batchIds.join(',')}&key=${SUBSCRIPTION_API_KEY}`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.items) {
                            allChannels = allChannels.concat(data.items);
                        }
                    }
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                if (allChannels.length > 0) {
                    // Convert channel data to subscription-like format
                    const subscriptionItems = allChannels.map(channel => ({
                        snippet: {
                            resourceId: {
                                channelId: channel.id
                            },
                            title: channel.snippet.title,
                            thumbnails: channel.snippet.thumbnails
                        }
                    }));
                    
                    subscriptionsData = subscriptionItems;
                    displaySubscriptions(subscriptionItems);
                } else {
                    showNoSubscriptionsMessage();
                }
                
            } catch (error) {
                console.error('Error fetching channel data for subscriptions:', error);
                showNoSubscriptionsMessage();
            }
        }
        
        // Display subscriptions
        function displaySubscriptions(subscriptions) {
            subscriptionsList.innerHTML = '';
            
            if (subscriptions.length === 0) {
                showNoSubscriptionsMessage();
                return;
            }
            
            subscriptions.forEach(subscription => {
                const channelId = subscription.snippet.resourceId.channelId;
                const channelName = subscription.snippet.title;
                const thumbnailUrl = subscription.snippet.thumbnails.default?.url || 
                                   subscription.snippet.thumbnails.medium?.url;
                
                // Get or generate channel logo
                const channelLogo = channelLogoCache[channelId] || getChannelLogo(channelId, channelName);
                
                const subscriptionItem = document.createElement('div');
                subscriptionItem.className = 'subscription-channel';
                subscriptionItem.setAttribute('data-channel-id', channelId);
                subscriptionItem.setAttribute('data-channel-name', channelName);
                
                subscriptionItem.innerHTML = `
                    <img src="${channelLogo}" alt="${channelName}" class="subscription-channel-avatar channel-logo-cached">
                    <div class="subscription-channel-name">${channelName}</div>
                    <div class="subscription-channel-handle">@${channelName.replace(/\s+/g, '').toLowerCase()}</div>
                    <div class="subscription-channel-subs">${formatNumber(Math.floor(Math.random() * 1000000))} subscribers</div>
                `;
                
                subscriptionItem.addEventListener('click', function() {
                    openChannelPage(channelId, channelName);
                });
                
                subscriptionsList.appendChild(subscriptionItem);
            });
        }
        
        // Show no subscriptions message
        function showNoSubscriptionsMessage() {
            subscriptionsList.innerHTML = `
                <div class="no-subscriptions">
                    <i class="fas fa-user-friends"></i>
                    <h3>No subscriptions yet</h3>
                    <p>Subscribe to channels to see them here</p>
                    <button class="browse-channels-btn" id="browseChannelsBtn">Browse Channels</button>
                </div>
            `;
            
            document.getElementById('browseChannelsBtn').addEventListener('click', function() {
                followingPage.style.display = 'none';
                appContainer.style.display = 'block';
            });
        }
        
        // Open channel page with optimized loading
        async function openChannelPage(channelId, channelName) {
            try {
                // Hide current page, show channel page
                appContainer.style.display = 'none';
                channelPage.style.display = 'block';
                followingPage.style.display = 'none';
                searchPage.style.display = 'none';
                
                // Show loading with cached logo if available
                const cachedLogo = channelLogoCache[channelId];
                if (cachedLogo) {
                    channelAvatarLarge.src = cachedLogo;
                    channelAvatarLarge.classList.remove('channel-logo-loading');
                }
                
                channelVideosGrid.innerHTML = `
                    <div class="loading" style="grid-column: 1/-1;">
                        <div class="spinner"></div>
                        <div>Loading channel information...</div>
                    </div>
                `;
                
                // Check cache for channel videos
                const cacheKey = `channel_${channelId}`;
                if (channelVideosCache[cacheKey] && Date.now() - channelVideosCache[cacheKey].timestamp < 3600000) { // 1 hour cache
                    const cachedData = channelVideosCache[cacheKey].data;
                    updateChannelHeaderFromCache(cachedData, channelId, channelName);
                    loadChannelVideosFromCache(cachedData);
                } else {
                    // Fetch from API
                    await fetchChannelDataFromAPI(channelId, channelName);
                }
                
            } catch (error) {
                console.error('Error opening channel page:', error);
                showNotification('Error', 'Failed to load channel. Showing cached version.');
                
                // Fallback: Show channel with cached data
                showCachedChannelData(channelId, channelName);
            }
        }
        
        // Update channel header from cache
        function updateChannelHeaderFromCache(cachedData, channelId, channelName) {
            // Set channel name
            channelNameLarge.textContent = channelName;
            channelNameModal.textContent = channelName;
            
            // Set channel handle
            const handle = cachedData.handle || `@${channelName.replace(/\s+/g, '').toLowerCase()}`;
            channelHandle.textContent = handle;
            
            // Get cached logo or generate one
            const logoUrl = channelLogoCache[channelId] || getChannelLogo(channelId, channelName);
            channelAvatarLarge.src = logoUrl;
            channelAvatarLarge.classList.remove('channel-logo-loading');
            channelLogoModal.src = logoUrl;
            channelLogoModal.classList.remove('channel-logo-loading');
            
            // Hide banner for cached data
            channelBannerImg.style.display = 'none';
            
            // Set stats from cache or defaults
            subscriberCount.textContent = formatNumber(cachedData.subscribers || Math.floor(Math.random() * 1000000));
            videoCount.textContent = formatNumber(cachedData.videoCount || Math.floor(Math.random() * 1000));
            totalViews.textContent = formatNumber(cachedData.totalViews || Math.floor(Math.random() * 10000000));
            channelSubsModal.textContent = `${formatNumber(cachedData.subscribers || Math.floor(Math.random() * 1000000))} subscribers`;
            
            // Set description
            const description = cachedData.description || `Welcome to ${channelName}'s channel!`;
            channelDescriptionText.textContent = description;
            
            // Check if description needs show more button
            if (description.length > 300) {
                channelDescriptionText.classList.remove('expanded');
                channelShowMoreBtn.style.display = 'block';
                channelShowMoreBtn.textContent = 'Show more';
            } else {
                channelShowMoreBtn.style.display = 'none';
                channelDescriptionText.classList.add('expanded');
            }
            
            // Check subscription status
            if (isSignedIn && accessToken) {
                checkYouTubeSubscriptionStatus(channelId);
            } else {
                const isSubscribed = subscribedChannels.includes(channelId);
                updateSubscribeButton(isSubscribed);
            }
        }
        
        // Fetch channel data from API
        async function fetchChannelDataFromAPI(channelId, channelName) {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,brandingSettings&id=${channelId}&key=${SUBSCRIPTION_API_KEY}`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.items && data.items.length > 0) {
                        const channel = data.items[0];
                        currentChannelData = channel;
                        
                        // Update channel header
                        updateChannelHeader(channel);
                        
                        // Update channel description with show more button
                        const description = channel.snippet.description || 'No description available';
                        channelDescriptionText.textContent = description;
                        
                        // Check if description needs show more button
                        if (description.length > 300) {
                            channelDescriptionText.classList.remove('expanded');
                            channelShowMoreBtn.style.display = 'block';
                            channelShowMoreBtn.textContent = 'Show more';
                        } else {
                            channelShowMoreBtn.style.display = 'none';
                            channelDescriptionText.classList.add('expanded');
                        }
                        
                        // Cache the channel data
                        const cacheKey = `channel_${channelId}`;
                        channelVideosCache[cacheKey] = {
                            timestamp: Date.now(),
                            data: {
                                subscribers: channel.statistics.subscriberCount,
                                videoCount: channel.statistics.videoCount,
                                totalViews: channel.statistics.viewCount,
                                description: channel.snippet.description,
                                handle: channel.snippet.customUrl || `@${channel.snippet.title.replace(/\s+/g, '').toLowerCase()}`
                            }
                        };
                        saveCacheToStorage();
                        
                        // Check subscription status
                        if (isSignedIn && accessToken) {
                            checkYouTubeSubscriptionStatus(channelId);
                        } else {
                            // Check local subscription status
                            const isSubscribed = subscribedChannels.includes(channelId);
                            updateSubscribeButton(isSubscribed);
                        }
                        
                        // Load channel videos
                        loadChannelVideos();
                        
                    } else {
                        throw new Error('Channel not found');
                    }
                } else {
                    throw new Error('Failed to fetch channel data');
                }
                
            } catch (error) {
                console.error('Error fetching channel data:', error);
                throw error;
            }
        }
        
        // Show cached channel data (fallback)
        function showCachedChannelData(channelId, channelName) {
            updateChannelHeaderFromCache({}, channelId, channelName);
            loadCachedChannelVideos(channelName);
            loadMockChannelShorts();
            loadMockChannelPosts();
        }
        
        // Load channel videos with caching
        async function loadChannelVideos() {
            try {
                if (!currentChannelData) return;
                
                const channelId = currentChannelData.id;
                const cacheKey = `channel_videos_${channelId}`;
                
                // Check cache first
                if (channelVideosCache[cacheKey] && Date.now() - channelVideosCache[cacheKey].timestamp < 1800000) { // 30 minutes cache
                    const cachedVideos = channelVideosCache[cacheKey].data;
                    displayChannelVideos(cachedVideos);
                    return;
                }
                
                // Show loading
                channelVideosGrid.innerHTML = `
                    <div class="loading" style="grid-column: 1/-1;">
                        <div class="spinner"></div>
                        <div>Loading videos...</div>
                    </div>
                `;
                
                // Fetch channel videos (limit to 20 for performance)
                const searchResponse = await fetch(
                    `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&maxResults=20&order=date&type=video&key=${SUBSCRIPTION_API_KEY}`
                );
                
                if (searchResponse.ok) {
                    const searchData = await searchResponse.json();
                    
                    if (searchData.items && searchData.items.length > 0) {
                        const videoIds = searchData.items.map(item => item.id.videoId);
                        
                        // Fetch video details in batches for better performance
                        const batchSize = 10;
                        let allVideos = [];
                        
                        for (let i = 0; i < videoIds.length; i += batchSize) {
                            const batchIds = videoIds.slice(i, i + batchSize);
                            const videosResponse = await fetch(
                                `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${batchIds.join(',')}&key=${SUBSCRIPTION_API_KEY}`
                            );
                            
                            if (videosResponse.ok) {
                                const videosData = await videosResponse.json();
                                allVideos = allVideos.concat(videosData.items);
                            }
                            
                            // Small delay to avoid rate limiting
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                        // Filter out shorts
                        const regularVideos = allVideos.filter(video => {
                            const duration = parseDuration(video.contentDetails.duration);
                            const title = video.snippet.title.toLowerCase();
                            const isShort = duration < 60 || title.includes('#short') || title.includes('#shorts');
                            return !isShort;
                        });
                        
                        // Cache the videos
                        channelVideosCache[cacheKey] = {
                            timestamp: Date.now(),
                            data: regularVideos
                        };
                        saveCacheToStorage();
                        
                        displayChannelVideos(regularVideos);
                    } else {
                        // No videos found
                        channelVideosGrid.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px; opacity: 0.7;">
                                <i class="fas fa-video-slash" style="font-size: 48px; margin-bottom: 15px;"></i>
                                <div>No videos found for this channel</div>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Error loading channel videos:', error);
                // Try to load from cache
                if (currentChannelData) {
                    const channelId = currentChannelData.id;
                    const cacheKey = `channel_videos_${channelId}`;
                    if (channelVideosCache[cacheKey]) {
                        displayChannelVideos(channelVideosCache[cacheKey].data);
                    } else {
                        loadCachedChannelVideos(currentChannelData.snippet.title);
                    }
                }
            }
        }
        
        // Load channel videos from cache
        function loadChannelVideosFromCache(cachedData) {
            // For now, load mock videos since we only cache metadata
            loadCachedChannelVideos(cachedData.title || 'Channel');
        }
        
        // Load cached channel videos
        function loadCachedChannelVideos(channelName) {
            const mockVideos = [];
            const categories = ['Gaming', 'Music', 'Education', 'Entertainment', 'Tech', 'Vlog', 'Tutorial', 'Review'];
            
            for (let i = 1; i <= 12; i++) { // Reduced to 12 for better performance
                mockVideos.push({
                    id: `mock${i}`,
                    snippet: {
                        title: `${channelName} - Video ${i} | ${categories[i % categories.length]}`,
                        thumbnails: {
                            high: { url: `https://picsum.photos/480/270?random=${i}&blur=0` },
                            medium: { url: `https://picsum.photos/320/180?random=${i}&blur=0` }
                        },
                        channelTitle: channelName,
                        publishedAt: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString()
                    },
                    statistics: {
                        viewCount: Math.floor(Math.random() * 1000000).toString(),
                        likeCount: Math.floor(Math.random() * 50000).toString()
                    },
                    contentDetails: {
                        duration: `PT${Math.floor(Math.random() * 30)}M${Math.floor(Math.random() * 60)}S`
                    }
                });
            }
            
            displayChannelVideos(mockVideos);
        }
        
        // Display channel videos
        function displayChannelVideos(videos) {
            channelVideosGrid.innerHTML = '';
            
            if (videos.length === 0) {
                channelVideosGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; opacity: 0.7;">
                        <i class="fas fa-video-slash" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <div>No videos found</div>
                    </div>
                `;
                return;
            }
            
            videos.forEach(video => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                videoItem.setAttribute('data-video-id', video.id);
                
                // Use high-quality thumbnail
                const thumbnailUrl = video.snippet.thumbnails.maxres?.url || 
                                   video.snippet.thumbnails.high?.url || 
                                   video.snippet.thumbnails.medium?.url || 
                                   video.snippet.thumbnails.default?.url ||
                                   `https://picsum.photos/480/270?random=${Math.random()}`;
                
                const title = video.snippet.title;
                const views = formatNumber(video.statistics?.viewCount || '0');
                const likes = formatNumber(video.statistics?.likeCount || '0');
                const duration = formatDuration(parseDuration(video.contentDetails.duration));
                const publishedAt = formatTimeAgo(video.snippet.publishedAt);
                
                videoItem.innerHTML = `
                    <div class="video-thumbnail-container">
                        <img src="${thumbnailUrl}" alt="${title}" class="video-thumbnail high-quality-thumbnail" loading="lazy">
                        <div class="video-duration">${duration}</div>
                    </div>
                    <div class="video-info">
                        <div class="video-title">${title}</div>
                        <div class="video-metadata">
                            <span>${views} views</span>
                            <span></span>
                            <span>${publishedAt}</span>
                        </div>
                    </div>
                `;
                
                // When clicking a video in channel page, close channel and play video
                videoItem.addEventListener('click', function() {
                    // Close channel page
                    channelPage.style.display = 'none';
                    appContainer.style.display = 'block';
                    
                    // Open the video in modal
                    setTimeout(() => {
                        openVideoModalFromChannel(video);
                    }, 100);
                });
                
                channelVideosGrid.appendChild(videoItem);
            });
        }
        
        // Open video modal from channel page
        async function openVideoModalFromChannel(video) {
            try {
                // If video is a mock video (from cache), fetch real data
                if (video.id && video.id.startsWith('mock')) {
                    // For mock videos, create a proper video object
                    const mockVideoData = {
                        id: video.id,
                        snippet: {
                            title: video.snippet.title,
                            description: `This is a video from ${video.snippet.channelTitle}.`,
                            thumbnails: video.snippet.thumbnails,
                            channelTitle: video.snippet.channelTitle,
                            channelId: 'mock_channel_id',
                            publishedAt: video.snippet.publishedAt
                        },
                        statistics: video.statistics || {
                            viewCount: '0',
                            likeCount: '0',
                            commentCount: '0'
                        },
                        contentDetails: video.contentDetails || {
                            duration: 'PT10M0S'
                        }
                    };
                    
                    openVideoModal(mockVideoData);
                } else {
                    // For real videos, fetch full details
                    const response = await fetch(
                        `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${video.id}&key=${SUBSCRIPTION_API_KEY}`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.items && data.items.length > 0) {
                            openVideoModal(data.items[0]);
                        } else {
                            // Fallback to basic video data
                            openVideoModal(video);
                        }
                    } else {
                        // Fallback to basic video data
                        openVideoModal(video);
                    }
                }
            } catch (error) {
                console.error('Error opening video from channel:', error);
                // Fallback to basic video data
                openVideoModal(video);
            }
        }
        
        // Load channel shorts
        async function loadChannelShorts() {
            try {
                if (!currentChannelData) return;
                
                const channelId = currentChannelData.id;
                
                // For now, show mock shorts
                loadMockChannelShorts();
                
            } catch (error) {
                console.error('Error loading channel shorts:', error);
                loadMockChannelShorts();
            }
        }
        
        // Load mock channel shorts
        function loadMockChannelShorts() {
            const mockShorts = [];
            for (let i = 1; i <= 8; i++) {
                mockShorts.push({
                    id: `short${i}`,
                    snippet: {
                        title: `Short Video ${i} - Quick Tips & Fun`,
                        thumbnails: {
                            medium: { url: `https://picsum.photos/180/320?random=${i+100}&blur=0` }
                        }
                    }
                });
            }
            
            displayChannelShorts(mockShorts);
        }
        
        // Display channel shorts
        function displayChannelShorts(shorts) {
            channelShortsGrid.innerHTML = '';
            
            if (shorts.length === 0) {
                channelShortsGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; opacity: 0.7;">
                        <i class="fas fa-film" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <div>No shorts found</div>
                    </div>
                `;
                return;
            }
            
            shorts.forEach(short => {
                const shortItem = document.createElement('div');
                shortItem.className = 'channel-short';
                shortItem.setAttribute('data-video-id', short.id);
                
                const thumbnailUrl = short.snippet.thumbnails.medium?.url || 
                                   `https://picsum.photos/180/320?random=${Math.random()}`;
                const title = short.snippet.title;
                
                shortItem.innerHTML = `
                    <img src="${thumbnailUrl}" alt="${title}" class="channel-short-thumbnail high-quality-thumbnail" loading="lazy">
                    <div class="channel-short-title">${title}</div>
                `;
                
                shortItem.addEventListener('click', function() {
                    playShortsVideo(short);
                });
                
                channelShortsGrid.appendChild(shortItem);
            });
        }
        
        // Play shorts video
        function playShortsVideo(short) {
            isShortsPlaying = true;
            shortsVideoId = short.id;
            
            videoModal.style.display = 'block';
            
            // Clear previous video
            videoPlayer.innerHTML = '';
            
            // Play the short
            videoPlayer.innerHTML = `
                <iframe width="100%" height="100%" src="https://www.youtube.com/embed/${short.id}?autoplay=1&controls=0&modestbranding=1&rel=0&showinfo=0&loop=1&playlist=${short.id}&enablejsapi=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                </iframe>
            `;
            
            // Hide other UI elements for shorts experience
            document.querySelector('.video-actions-bar').style.display = 'none';
            document.querySelector('.scrollable-content').style.display = 'none';
            document.querySelector('.close-modal').style.display = 'none';
            
            // Hide ad banner for shorts
            adBannerContainer.style.display = 'none';
            
            // Clear comment interval
            if (commentInterval) {
                clearInterval(commentInterval);
                commentInterval = null;
            }
            
            // Clear player interval
            if (playerInterval) {
                clearInterval(playerInterval);
                playerInterval = null;
            }
            
            // Add close button for shorts
            const existingCloseBtn = document.getElementById('shortsCloseBtn');
            if (existingCloseBtn) existingCloseBtn.remove();
            
            const shortsCloseBtn = document.createElement('button');
            shortsCloseBtn.id = 'shortsCloseBtn';
            shortsCloseBtn.innerHTML = '<i class="fas fa-times"></i>';
            shortsCloseBtn.style.position = 'absolute';
            shortsCloseBtn.style.top = '20px';
            shortsCloseBtn.style.right = '20px';
            shortsCloseBtn.style.zIndex = '100';
            shortsCloseBtn.style.background = 'rgba(0,0,0,0.5)';
            shortsCloseBtn.style.border = 'none';
            shortsCloseBtn.style.color = 'white';
            shortsCloseBtn.style.fontSize = '24px';
            shortsCloseBtn.style.width = '40px';
            shortsCloseBtn.style.height = '40px';
            shortsCloseBtn.style.borderRadius = '50%';
            shortsCloseBtn.style.cursor = 'pointer';
            shortsCloseBtn.style.display = 'flex';
            shortsCloseBtn.style.alignItems = 'center';
            shortsCloseBtn.style.justifyContent = 'center';
            
            shortsCloseBtn.addEventListener('click', function() {
                videoModal.style.display = 'none';
                videoPlayer.innerHTML = '';
                isShortsPlaying = false;
                shortsVideoId = null;
                document.querySelector('.video-actions-bar').style.display = 'flex';
                document.querySelector('.scrollable-content').style.display = 'block';
                document.querySelector('.close-modal').style.display = 'block';
                
                // Clear comment interval
                if (commentInterval) {
                    clearInterval(commentInterval);
                    commentInterval = null;
                }
            });
            
            videoModal.querySelector('.modal-content').appendChild(shortsCloseBtn);
            
            showNotification('Shorts', 'Playing short video. Click the X button to close.');
        }
        
        // Load channel posts (optimized)
        async function loadChannelPosts() {
            try {
                // Load posts quickly without API calls
                loadQuickChannelPosts();
                
            } catch (error) {
                console.error('Error loading channel posts:', error);
                loadQuickChannelPosts();
            }
        }
        
        // Load quick channel posts
        function loadQuickChannelPosts() {
            const mockPosts = [];
            const postTypes = ['Announcement', 'Update', 'Question', 'Poll', 'Behind the Scenes'];
            
            // Only 4 posts for faster loading
            for (let i = 1; i <= 4; i++) {
                mockPosts.push({
                    id: `post${i}`,
                    snippet: {
                        title: `${postTypes[i % postTypes.length]} Post ${i}`,
                        description: `This is a community post from the channel. ${i % 3 === 0 ? 'Check out our latest video!' : 'What do you think about this?'}`,
                        thumbnails: {
                            standard: { url: `https://picsum.photos/400/225?random=${i+200}&blur=0` }
                        },
                        publishedAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString()
                    },
                    statistics: {
                        likeCount: Math.floor(Math.random() * 1000),
                        commentCount: Math.floor(Math.random() * 100)
                    }
                });
            }
            
            displayChannelPosts(mockPosts);
        }
        
        // Display channel posts
        function displayChannelPosts(posts) {
            channelPostsGrid.innerHTML = '';
            
            if (posts.length === 0) {
                channelPostsGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; opacity: 0.7;">
                        <i class="fas fa-newspaper" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <div>No community posts available</div>
                    </div>
                `;
                return;
            }
            
            posts.forEach(post => {
                const postItem = document.createElement('div');
                postItem.className = 'channel-post';
                postItem.setAttribute('data-post-id', post.id);
                
                const hasImage = Math.random() > 0.5; // 50% chance of image
                const imageUrl = hasImage ? post.snippet.thumbnails.standard?.url || `https://picsum.photos/400/225?random=${Math.random()}` : '';
                const title = post.snippet.title;
                const description = post.snippet.description;
                const likes = formatNumber(post.statistics?.likeCount || 0);
                const comments = formatNumber(post.statistics?.commentCount || 0);
                const publishedAt = formatTimeAgo(post.snippet.publishedAt);
                
                postItem.innerHTML = `
                    <div class="post-content">
                        <h3 style="margin-bottom: 10px; font-size: 16px;">${title}</h3>
                        <div class="post-text">${description}</div>
                        ${hasImage ? `<img src="${imageUrl}" alt="${title}" class="post-image high-quality-thumbnail" loading="lazy">` : ''}
                        <div class="post-stats">
                            <span><i class="far fa-thumbs-up"></i> ${likes}</span>
                            <span><i class="far fa-comment"></i> ${comments}</span>
                            <span>${publishedAt}</span>
                        </div>
                    </div>
                `;
                
                channelPostsGrid.appendChild(postItem);
            });
        }
        
        // Update channel header
        function updateChannelHeader(channel) {
            // Set channel name
            channelNameLarge.textContent = channel.snippet.title;
            channelNameModal.textContent = channel.snippet.title;
            
            // Set channel handle
            const handle = channel.snippet.customUrl || `@${channel.snippet.title.replace(/\s+/g, '').toLowerCase()}`;
            channelHandle.textContent = handle;
            
            // Get high-quality channel avatar
            const avatarUrl = channel.snippet.thumbnails.high?.url || 
                            channel.snippet.thumbnails.medium?.url || 
                            channel.snippet.thumbnails.default?.url;
            
            if (avatarUrl) {
                // Cache the logo
                channelLogoCache[channel.id] = avatarUrl;
                saveCacheToStorage();
                
                // Remove loading class and set real logo
                channelAvatarLarge.classList.remove('channel-logo-loading');
                channelAvatarLarge.src = avatarUrl;
                channelLogoModal.classList.remove('channel-logo-loading');
                channelLogoModal.src = avatarUrl;
            }
            
            // Get channel banner
            if (channel.brandingSettings?.image?.bannerExternalUrl) {
                channelBannerImg.src = channel.brandingSettings.image.bannerExternalUrl;
                channelBannerImg.style.display = 'block';
            } else if (channel.brandingSettings?.image?.bannerTabletHdImageUrl) {
                channelBannerImg.src = channel.brandingSettings.image.bannerTabletHdImageUrl;
                channelBannerImg.style.display = 'block';
            } else if (channel.brandingSettings?.image?.bannerTabletImageUrl) {
                channelBannerImg.src = channel.brandingSettings.image.bannerTabletImageUrl;
                channelBannerImg.style.display = 'block';
            } else if (channel.brandingSettings?.image?.bannerMobileHdImageUrl) {
                channelBannerImg.src = channel.brandingSettings.image.bannerMobileHdImageUrl;
                channelBannerImg.style.display = 'block';
            } else {
                channelBannerImg.style.display = 'none';
            }
            
            // Update stats
            subscriberCount.textContent = formatNumber(channel.statistics.subscriberCount);
            videoCount.textContent = formatNumber(channel.statistics.videoCount);
            totalViews.textContent = formatNumber(channel.statistics.viewCount);
            channelSubsModal.textContent = `${formatNumber(channel.statistics.subscriberCount)} subscribers`;
        }
        
        // Check subscription status via YouTube API
        async function checkYouTubeSubscriptionStatus(channelId) {
            try {
                const token = await getValidAccessToken();
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&mine=true&forChannelId=${channelId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    const isSubscribed = data.items && data.items.length > 0;
                    updateSubscribeButton(isSubscribed);
                    
                    // Update local storage
                    if (isSubscribed && !subscribedChannels.includes(channelId)) {
                        subscribedChannels.push(channelId);
                        localStorage.setItem('edirear_subscribed_channels', JSON.stringify(subscribedChannels));
                    }
                } else {
                    // Fallback to local storage
                    const isSubscribed = subscribedChannels.includes(channelId);
                    updateSubscribeButton(isSubscribed);
                }
            } catch (error) {
                console.error('Error checking subscription status:', error);
                // Fallback to local storage
                const isSubscribed = subscribedChannels.includes(channelId);
                updateSubscribeButton(isSubscribed);
            }
        }
        
        // Toggle channel subscription
        async function toggleChannelSubscription() {
            // Check if user is signed in
            if (!isSignedIn || !accessToken) {
                showNotification('Sign In Required', 'Please sign in with Google to subscribe to channels.');
                return;
            }
            
            let channelId;
            
            // Get channel ID from current context
            if (currentChannelData) {
                channelId = currentChannelData.id;
            } else if (currentVideo && currentVideo.snippet) {
                channelId = currentVideo.snippet.channelId;
                // Fetch channel data if not already available
                if (!currentChannelData) {
                    try {
                        const response = await fetch(
                            `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,brandingSettings&id=${channelId}&key=${SUBSCRIPTION_API_KEY}`
                        );
                        if (response.ok) {
                            const data = await response.json();
                            if (data.items && data.items.length > 0) {
                                currentChannelData = data.items[0];
                                updateChannelHeader(currentChannelData);
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching channel data:', error);
                    }
                }
            } else {
                showNotification('Error', 'No channel selected.');
                return;
            }
            
            if (!channelId) {
                showNotification('Error', 'Channel not found.');
                return;
            }
            
            const isSubscribed = channelSubscribeBtn.classList.contains('subscribed') || 
                               modalSubscribeBtn.classList.contains('subscribed');
            
            try {
                const token = await getValidAccessToken();
                
                if (isSubscribed) {
                    // Unsubscribe from YouTube
                    await unsubscribeFromYouTube(channelId, token);
                    showNotification('Unsubscribed', `Unsubscribed from ${currentChannelData ? currentChannelData.snippet.title : 'this channel'} on YouTube`);
                } else {
                    // Subscribe on YouTube
                    await subscribeOnYouTube(channelId, token);
                    showNotification('Subscribed', `Subscribed to ${currentChannelData ? currentChannelData.snippet.title : 'this channel'} on YouTube`);
                }
                
                // Update button state
                updateSubscribeButton(!isSubscribed);
                
            } catch (error) {
                console.error('Error toggling subscription:', error);
                showNotification('Error', 'Failed to update subscription. Please try again.');
            }
        }
        
        // Subscribe to a channel on YouTube
        async function subscribeOnYouTube(channelId, token) {
            const subscriptionData = {
                snippet: {
                    resourceId: {
                        kind: 'youtube#channel',
                        channelId: channelId
                    }
                }
            };
            
            const response = await fetch(
                'https://www.googleapis.com/youtube/v3/subscriptions?part=snippet',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(subscriptionData)
                }
            );
            
            if (!response.ok) {
                const errorData = await response.json();
                console.error('YouTube subscription error:', errorData);
                throw new Error(`YouTube subscription failed: ${response.status}`);
            }
            
            // Update local storage
            if (!subscribedChannels.includes(channelId)) {
                subscribedChannels.push(channelId);
                localStorage.setItem('edirear_subscribed_channels', JSON.stringify(subscribedChannels));
            }
            
            return response.json();
        }
        
        // Unsubscribe from a channel on YouTube
        async function unsubscribeFromYouTube(channelId, token) {
            // First, get the subscription ID
            const subscriptionResponse = await fetch(
                `https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&mine=true&forChannelId=${channelId}`,
                {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                }
            );
            
            if (subscriptionResponse.ok) {
                const subscriptionData = await subscriptionResponse.json();
                
                if (subscriptionData.items && subscriptionData.items.length > 0) {
                    const subscriptionId = subscriptionData.items[0].id;
                    
                    // Delete the subscription
                    const deleteResponse = await fetch(
                        `https://www.googleapis.com/youtube/v3/subscriptions?id=${subscriptionId}`,
                        {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        }
                    );
                    
                    if (!deleteResponse.ok) {
                        const errorData = await deleteResponse.json();
                        console.error('YouTube unsubscribe error:', errorData);
                        throw new Error(`YouTube unsubscribe failed: ${deleteResponse.status}`);
                    }
                    
                    // Update local storage
                    subscribedChannels = subscribedChannels.filter(id => id !== channelId);
                    localStorage.setItem('edirear_subscribed_channels', JSON.stringify(subscribedChannels));
                    
                    return true;
                }
            }
            
            throw new Error('Subscription not found');
        }
        
        // Update subscribe button state
        function updateSubscribeButton(isSubscribed) {
            if (isSubscribed) {
                channelSubscribeBtn.textContent = 'Subscribed';
                channelSubscribeBtn.classList.add('subscribed');
                modalSubscribeBtn.textContent = 'Subscribed';
                modalSubscribeBtn.classList.add('subscribed');
            } else {
                channelSubscribeBtn.textContent = 'Subscribe';
                channelSubscribeBtn.classList.remove('subscribed');
                modalSubscribeBtn.textContent = 'Subscribe';
                modalSubscribeBtn.classList.remove('subscribed');
            }
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        }
        
        // Load personalized videos based on user interests
        async function loadPersonalizedVideos() {
            try {
                currentApiKeyIndex = 0;
                nextPageToken = null;
                isLoadingMore = false;
                
                videoFeed.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>Loading personalized videos based on your interests...</div>
                    </div>
                `;
                
                if (userInterests && userInterests.length > 0) {
                    currentSearchQuery = userInterests[0];
                    
                    const searchResponse = await fetch(
                        `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(currentSearchQuery)}&type=video&maxResults=20&regionCode=${userCountry}&key=${API_KEYS[currentApiKeyIndex]}`
                    );
                    
                    if (!searchResponse.ok) {
                        throw new Error(`YouTube API error: ${searchResponse.status}`);
                    }
                    
                    const searchData = await searchResponse.json();
                    const videoIds = searchData.items.map(item => item.id.videoId);
                    nextPageToken = searchData.nextPageToken || null;
                    
                    if (videoIds.length > 0) {
                        const videosResponse = await fetch(
                            `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoIds.join(',')}&key=${API_KEYS[currentApiKeyIndex]}`
                        );
                        
                        if (videosResponse.ok) {
                            const videosData = await videosResponse.json();
                            const regularVideos = videosData.items.filter(video => {
                                return !isShortVideo(video);
                            });
                            
                            userVideos = regularVideos;
                            displayVideos(userVideos);
                            return;
                        }
                    }
                }
                
                await loadTrendingVideos();
                
            } catch (error) {
                console.error('Error loading personalized videos:', error);
                await loadTrendingVideos();
            }
        }
        
        // Check if a video is a short
        function isShortVideo(video) {
            const duration = parseDuration(video.contentDetails.duration);
            if (duration < 60) {
                return true;
            }
            
            const title = video.snippet.title.toLowerCase();
            const shortIndicators = ['#short', '#shorts', 'short', 'shorts', 'short video', 'shorts video'];
            if (shortIndicators.some(indicator => title.includes(indicator))) {
                return true;
            }
            
            return false;
        }
        
        // Load videos by category
        async function loadVideosByCategory(categoryId) {
            try {
                currentApiKeyIndex = 0;
                nextPageToken = null;
                isLoadingMore = false;
                
                videoFeed.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>Loading videos from ${userCountry} in selected category...</div>
                    </div>
                `;
                
                if (categoryId === '0') {
                    await loadTrendingVideos();
                } else {
                    const response = await fetch(
                        `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&chart=mostPopular&regionCode=${userCountry}&videoCategoryId=${categoryId}&maxResults=50&key=${API_KEYS[0]}`
                    );
                    
                    if (!response.ok) {
                        throw new Error(`YouTube API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.items || data.items.length === 0) {
                        throw new Error('No videos found in this category');
                    }
                    
                    const regularVideos = data.items.filter(video => {
                        return !isShortVideo(video);
                    });
                    
                    userVideos = regularVideos;
                    displayVideos(regularVideos);
                }
                
            } catch (error) {
                console.error('Error loading category videos:', error);
                videoFeed.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3>Failed to load videos</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 15px; font-size: 14px; opacity: 0.7;">
                            Please check your connection and try again later.
                        </p>
                    </div>
                `;
            }
        }
        
        // Load more videos when Load More button is clicked
        async function loadMoreVideos() {
            if (isLoadingMore) return;
            
            isLoadingMore = true;
            
            try {
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                loadMoreBtn.disabled = true;
                loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                
                if (!nextPageToken && currentApiKeyIndex < API_KEYS.length - 1) {
                    currentApiKeyIndex++;
                    nextPageToken = null;
                }
                
                let searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(currentSearchQuery)}&type=video&maxResults=20&regionCode=${userCountry}&key=${API_KEYS[currentApiKeyIndex]}`;
                
                if (nextPageToken) {
                    searchUrl += `&pageToken=${nextPageToken}`;
                }
                
                const searchResponse = await fetch(searchUrl);
                
                if (!searchResponse.ok) {
                    throw new Error(`YouTube API error: ${searchResponse.status}`);
                }
                
                const searchData = await searchResponse.json();
                const videoIds = searchData.items.map(item => item.id.videoId);
                nextPageToken = searchData.nextPageToken || null;
                
                if (videoIds.length > 0) {
                    const videosResponse = await fetch(
                        `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoIds.join(',')}&key=${API_KEYS[currentApiKeyIndex]}`
                    );
                    
                    if (videosResponse.ok) {
                        const videosData = await videosResponse.json();
                        const regularVideos = videosData.items.filter(video => {
                            return !isShortVideo(video);
                        });
                        
                        userVideos = [...userVideos, ...regularVideos];
                        displayVideos(userVideos);
                    }
                } else {
                    showNotification('No More Videos', 'No more videos available for this topic.');
                    loadMoreBtn.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading more videos:', error);
                showNotification('Load Failed', 'Failed to load more videos. Please try again.');
            } finally {
                isLoadingMore = false;
            }
        }
        
        // Load trending videos as fallback
        async function loadTrendingVideos() {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&chart=mostPopular&regionCode=${userCountry}&maxResults=50&key=${API_KEYS[0]}`
                );
                
                if (!response.ok) {
                    throw new Error(`YouTube API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.items || data.items.length === 0) {
                    throw new Error('No videos found');
                }
                
                const regularVideos = data.items.filter(video => {
                    return !isShortVideo(video);
                });
                
                userVideos = regularVideos;
                displayVideos(regularVideos);
                
            } catch (error) {
                console.error('Error loading trending videos:', error);
                videoFeed.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3>Failed to load videos</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 15px; font-size: 14px; opacity: 0.7;">
                            Please check your connection and try again later.
                        </p>
                    </div>
                `;
            }
        }
        
        // Handle video upload
        async function handleVideoUpload(e) {
            e.preventDefault();
            
            if (!isSignedIn) {
                showNotification('Sign In Required', 'Please sign in with Google to upload videos.');
                return;
            }
            
            const title = document.getElementById('videoTitleInput').value;
            const description = document.getElementById('videoDescription').value;
            const privacyStatus = document.getElementById('videoPrivacy').value;
            const category = document.getElementById('videoCategory').value;
            const tags = document.getElementById('videoTags').value;
            const thumbnailFile = document.getElementById('videoThumbnail').files[0];
            const videoFile = document.getElementById('videoFile').files[0];
            
            if (!videoFile) {
                showNotification('Upload Error', 'Please select a video file to upload.');
                return;
            }
            
            try {
                const token = await getValidAccessToken();
                const uploadBtn = uploadForm.querySelector('.upload-btn');
                uploadBtn.textContent = 'Uploading...';
                uploadBtn.disabled = true;
                
                const metadata = {
                    snippet: {
                        title: title,
                        description: description,
                        tags: tags.split(',').map(tag => tag.trim()),
                        categoryId: category
                    },
                    status: {
                        privacyStatus: privacyStatus
                    }
                };
                
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                formData.append('file', videoFile);
                
                const response = await fetch('https://www.googleapis.com/upload/youtube/v3/videos?part=snippet,status', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (thumbnailFile && result.id) {
                    await uploadThumbnail(result.id, thumbnailFile, token);
                }
                
                uploadForm.reset();
                thumbnailPreview.style.display = 'none';
                uploadModal.style.display = 'none';
                
                showNotification('Upload Successful', 'Video uploaded successfully! It may take a few minutes to process.');
                loadPersonalizedVideos();
                
            } catch (error) {
                console.error('Error uploading video:', error);
                showNotification('Upload Failed', 'Failed to upload video. Please try again.');
            } finally {
                const uploadBtn = uploadForm.querySelector('.upload-btn');
                uploadBtn.textContent = 'Upload';
                uploadBtn.disabled = false;
            }
        }
        
        // Upload thumbnail for a video
        async function uploadThumbnail(videoId, thumbnailFile, token) {
            const formData = new FormData();
            formData.append('file', thumbnailFile);
            
            const response = await fetch(
                `https://www.googleapis.com/youtube/v3/thumbnails/set?videoId=${videoId}`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                }
            );
            
            if (!response.ok) {
                console.error('Failed to upload thumbnail:', response.status);
            }
            
            return response.ok;
        }
        
        // Parse YouTube duration format (PT1H2M3S) to seconds
        function parseDuration(duration) {
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            const hours = (match[1] || '0H').replace('H', '');
            const minutes = (match[2] || '0M').replace('M', '');
            const seconds = (match[3] || '0S').replace('S', '');
            return parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseInt(seconds);
        }
        
        // Format duration from seconds to HH:MM:SS or MM:SS
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        // Display videos in the feed with optimized channel logos
        function displayVideos(videos) {
            videoFeed.innerHTML = '';
            
            if (videos.length === 0) {
                videoFeed.innerHTML = '<div class="error-message">No videos found</div>';
                return;
            }
            
            videos.forEach(video => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                videoItem.setAttribute('data-video-id', video.id);
                
                // Use high-quality thumbnail
                const thumbnailUrl = video.snippet.thumbnails.maxres?.url || 
                                   video.snippet.thumbnails.high?.url || 
                                   video.snippet.thumbnails.medium?.url || 
                                   video.snippet.thumbnails.default?.url;
                const title = video.snippet.title;
                const channel = video.snippet.channelTitle;
                const views = formatNumber(video.statistics.viewCount);
                const publishedAt = formatTimeAgo(video.snippet.publishedAt);
                const duration = formatDuration(parseDuration(video.contentDetails.duration));
                
                // Get or generate channel logo
                const channelId = video.snippet.channelId;
                const channelLogo = getChannelLogo(channelId, channel);
                
                videoItem.innerHTML = `
                    <div class="video-thumbnail-container">
                        <img src="${thumbnailUrl}" alt="${title}" class="video-thumbnail high-quality-thumbnail" loading="lazy">
                        <div class="video-duration">${duration}</div>
                    </div>
                    <div class="video-info">
                        <div class="video-title">${title}</div>
                        <div class="video-channel-info" data-channel-id="${channelId}" data-channel-name="${channel}">
                            <img src="${channelLogo}" alt="${channel}" class="channel-logo-small channel-logo-cached">
                            <div class="video-channel">${channel}</div>
                        </div>
                        <div class="video-metadata">
                            <span>${views} views</span>
                            <span></span>
                            <span>${publishedAt}</span>
                        </div>
                    </div>
                `;
                
                videoItem.addEventListener('click', function() {
                    openVideoModal(video);
                });
                
                // Add click event to channel info
                const channelInfo = videoItem.querySelector('.video-channel-info');
                channelInfo.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const channelId = this.getAttribute('data-channel-id');
                    const channelName = this.getAttribute('data-channel-name');
                    openChannelPage(channelId, channelName);
                });
                
                videoFeed.appendChild(videoItem);
            });
            
            if (nextPageToken || currentApiKeyIndex < API_KEYS.length - 1) {
                const loadMoreContainer = document.createElement('div');
                loadMoreContainer.className = 'load-more-container';
                loadMoreContainer.innerHTML = `
                    <button class="load-more-btn" id="loadMoreBtn">
                        <i class="fas fa-plus"></i> Load More Videos
                    </button>
                `;
                videoFeed.appendChild(loadMoreContainer);
                
                document.getElementById('loadMoreBtn').addEventListener('click', loadMoreVideos);
            }
        }
        
        // Open video modal and play video
        async function openVideoModal(video) {
            currentVideo = video;
            
            // Show modal
            videoModal.style.display = 'block';
            
            // Show ad banner
            adBannerContainer.style.display = 'block';
            
            // Set video info
            videoTitle.textContent = video.snippet.title;
            videoViews.textContent = `${formatNumber(video.statistics.viewCount)} views`;
            videoLikes.textContent = `${formatNumber(video.statistics.likeCount)} likes`;
            videoComments.textContent = `${formatNumber(video.statistics.commentCount)} comments`;
            
            // Update comments count
            commentsCount.textContent = formatNumber(video.statistics.commentCount);
            
            // Set description (only first line by default)
            const fullDescription = video.snippet.description || 'No description available';
            videoDescription.textContent = fullDescription;
            
            // Show "Show more" button if description is long
            if (fullDescription.length > 300) {
                videoDescription.classList.remove('expanded');
                showMoreBtn.style.display = 'block';
                showMoreBtn.textContent = 'Show more';
            } else {
                showMoreBtn.style.display = 'none';
                videoDescription.classList.add('expanded');
            }
            
            // Set like count
            likeCount.textContent = formatNumber(video.statistics.likeCount);
            
            // Check if video is liked
            videoLikedStatus = likedVideos[video.id] || false;
            updateLikeButton();
            
            // Set channel logo in modal using cache
            const channelId = video.snippet.channelId;
            const channelLogo = channelLogoCache[channelId] || getChannelLogo(channelId, video.snippet.channelTitle);
            channelLogoModal.src = channelLogo;
            channelLogoModal.classList.remove('channel-logo-loading');
            channelLogoModal.classList.add('channel-logo-cached');
            channelNameModal.textContent = video.snippet.channelTitle;
            
            // Get subscriber count
            channelSubsModal.textContent = `${formatNumber(Math.floor(Math.random() * 1000000))} subscribers`;
            
            // Check subscription status
            if (isSignedIn && accessToken) {
                // Enable subscribe button for signed-in users
                modalSubscribeBtn.classList.remove('disabled');
                modalSubscribeBtn.disabled = false;
                
                // Enable like button for signed-in users
                likeBtn.disabled = false;
                likeBtn.style.cursor = 'pointer';
                likeBtn.style.opacity = '1';
                
                // Enable save button for signed-in users
                addToPlaylistBtn.disabled = false;
                addToPlaylistBtn.style.cursor = 'pointer';
                addToPlaylistBtn.style.opacity = '1';
                
                // Enable share button for signed-in users
                shareBtn.disabled = false;
                shareBtn.style.cursor = 'pointer';
                shareBtn.style.opacity = '1';
                
                // Check subscription status via YouTube API
                checkModalSubscriptionStatus(video.snippet.channelId);
            } else {
                // Disable subscribe button for non-signed-in users
                modalSubscribeBtn.classList.add('disabled');
                modalSubscribeBtn.disabled = true;
                
                // Disable like button for non-signed-in users
                likeBtn.disabled = true;
                likeBtn.style.cursor = 'not-allowed';
                likeBtn.style.opacity = '0.5';
                
                // Disable save button for non-signed-in users
                addToPlaylistBtn.disabled = true;
                addToPlaylistBtn.style.cursor = 'not-allowed';
                addToPlaylistBtn.style.opacity = '0.5';
                
                // Disable share button for non-signed-in users
                shareBtn.disabled = true;
                shareBtn.style.cursor = 'not-allowed';
                shareBtn.style.opacity = '0.5';
                
                // Check local subscription status
                const isSubscribed = subscribedChannels.includes(video.snippet.channelId);
                updateModalSubscribeButton(isSubscribed);
            }
            
            // Load suggested videos
            loadSuggestedVideos(video);
            
            // Load comments
            loadVideoComments(video.id);
            
            // Create YouTube player with resume position
            let startSeconds = 0;
            if (videoPlaybackData.videoId === video.id && videoPlaybackData.duration) {
                startSeconds = videoPlaybackData.duration;
            }
            
            createYouTubePlayer(video.id, startSeconds);
            
            // Scroll the scrollable-content to the top when the modal opens
            const scrollableContent = videoModal.querySelector('.scrollable-content');
            if (scrollableContent) {
                scrollableContent.scrollTop = 0;
            }
        }
        
        // Load video comments
        async function loadVideoComments(videoId) {
            try {
                commentsList.innerHTML = `
                    <div class="loading-comments">
                        <div class="spinner" style="width: 20px; height: 20px; margin: 0 auto 10px;"></div>
                        Loading comments...
                    </div>
                `;
                
                // First, check if user is signed in
                if (!isSignedIn || !accessToken) {
                    commentsList.innerHTML = `
                        <div class="no-comments">
                            <i class="fas fa-comment-slash" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>Sign in to view and post comments</div>
                        </div>
                    `;
                    return;
                }
                
                const token = await getValidAccessToken();
                
                // Fetch comments from YouTube API
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&maxResults=20&order=relevance&textFormat=plainText`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.items && data.items.length > 0) {
                        videoCommentsData = data.items;
                        displayComments(videoCommentsData);
                        
                        // Start interval to check for new comments
                        startCommentRefreshInterval(videoId);
                    } else {
                        commentsList.innerHTML = `
                            <div class="no-comments">
                                <i class="fas fa-comment" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <div>No comments yet. Be the first to comment!</div>
                            </div>
                        `;
                        
                        // Start interval to check for new comments (even if there are none initially)
                        startCommentRefreshInterval(videoId);
                    }
                } else {
                    throw new Error('Failed to load comments');
                }
                
            } catch (error) {
                console.error('Error loading comments:', error);
                commentsList.innerHTML = `
                    <div class="no-comments">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>Failed to load comments. Please try again.</div>
                    </div>
                `;
            }
        }
        
        // Display comments
        function displayComments(comments) {
            commentsList.innerHTML = '';
            
            if (comments.length === 0) {
                commentsList.innerHTML = `
                    <div class="no-comments">
                        <i class="fas fa-comment" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>No comments yet. Be the first to comment!</div>
                    </div>
                `;
                return;
            }
            
            comments.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.setAttribute('data-comment-id', comment.id);
                
                const snippet = comment.snippet.topLevelComment.snippet;
                const author = snippet.authorDisplayName;
                const text = snippet.textDisplay;
                const likeCount = snippet.likeCount;
                const publishedAt = formatTimeAgo(snippet.publishedAt);
                const authorProfileImage = snippet.authorProfileImageUrl || 'https://via.placeholder.com/40/333/fff?text=U';
                const authorChannelId = snippet.authorChannelId?.value;
                
                commentItem.innerHTML = `
                    <img src="${authorProfileImage}" alt="${author}" class="comment-avatar">
                    <div class="comment-content">
                        <div class="comment-header">
                            <div class="comment-author">${author}</div>
                            <div class="comment-time">${publishedAt}</div>
                        </div>
                        <div class="comment-text">${text}</div>
                        <div class="comment-actions">
                            <button class="comment-action like-comment-btn" data-comment-id="${comment.id}">
                                <i class="far fa-thumbs-up"></i> ${formatNumber(likeCount)}
                            </button>
                            <button class="comment-action reply-comment-btn">
                                <i class="far fa-comment"></i> Reply
                            </button>
                        </div>
                    </div>
                `;
                
                commentsList.appendChild(commentItem);
            });
            
            // Add event listeners for comment actions
            document.querySelectorAll('.like-comment-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const commentId = this.getAttribute('data-comment-id');
                    likeComment(commentId);
                });
            });
        }
        
        // Start comment refresh interval
        function startCommentRefreshInterval(videoId) {
            // Clear existing interval
            if (commentInterval) {
                clearInterval(commentInterval);
            }
            
            // Start new interval to refresh comments every 30 seconds
            commentInterval = setInterval(async () => {
                await refreshComments(videoId);
            }, 30000);
        }
        
        // Refresh comments
        async function refreshComments(videoId) {
            try {
                if (!isSignedIn || !accessToken || !currentVideo) return;
                
                const token = await getValidAccessToken();
                
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&maxResults=20&order=relevance&textFormat=plainText`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.items && data.items.length > 0) {
                        // Check if comments have changed
                        const newComments = data.items;
                        const oldComments = videoCommentsData;
                        
                        // Simple check: if lengths are different, update
                        if (newComments.length !== oldComments.length) {
                            videoCommentsData = newComments;
                            displayComments(videoCommentsData);
                        }
                    }
                }
            } catch (error) {
                console.error('Error refreshing comments:', error);
            }
        }
        
        // Post a comment
        async function postComment() {
            if (!isSignedIn || !accessToken || !currentVideo) {
                showNotification('Sign In Required', 'Please sign in to post a comment.');
                return;
            }
            
            const commentText = commentInput.value.trim();
            if (!commentText) {
                showNotification('Empty Comment', 'Please enter a comment.');
                return;
            }
            
            try {
                const token = await getValidAccessToken();
                postCommentBtn.disabled = true;
                postCommentBtn.textContent = 'Posting...';
                
                const commentData = {
                    snippet: {
                        channelId: currentVideo.snippet.channelId,
                        videoId: currentVideo.id,
                        topLevelComment: {
                            snippet: {
                                textOriginal: commentText
                            }
                        }
                    }
                };
                
                const response = await fetch(
                    'https://www.googleapis.com/youtube/v3/commentThreads?part=snippet',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(commentData)
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Failed to post comment: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Clear input
                commentInput.value = '';
                postCommentBtn.disabled = true;
                
                // Show success notification
                showNotification('Comment Posted', 'Your comment has been posted successfully!');
                
                // Refresh comments
                await loadVideoComments(currentVideo.id);
                
                // Update comments count
                const currentCount = parseInt(videoComments.textContent.replace(/[^0-9]/g, ''));
                videoComments.textContent = `${formatNumber(currentCount + 1)} comments`;
                commentsCount.textContent = formatNumber(currentCount + 1);
                
            } catch (error) {
                console.error('Error posting comment:', error);
                showNotification('Error', 'Failed to post comment. Please try again.');
            } finally {
                postCommentBtn.textContent = 'Comment';
            }
        }
        
        // Like a comment
        async function likeComment(commentId) {
            if (!isSignedIn || !accessToken) {
                showNotification('Sign In Required', 'Please sign in to like comments.');
                return;
            }
            
            try {
                const token = await getValidAccessToken();
                
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/comments/rate?id=${commentId}&rating=like`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                if (response.ok) {
                    showNotification('Liked', 'Comment liked!');
                    
                    // Update the like count in the UI
                    const likeBtn = document.querySelector(`[data-comment-id="${commentId}"] .like-comment-btn`);
                    if (likeBtn) {
                        const currentText = likeBtn.textContent;
                        const currentCount = parseInt(currentText.replace(/[^0-9]/g, '') || '0');
                        likeBtn.innerHTML = `<i class="fas fa-thumbs-up"></i> ${formatNumber(currentCount + 1)}`;
                        likeBtn.classList.add('comment-liked');
                    }
                } else {
                    throw new Error('Failed to like comment');
                }
                
            } catch (error) {
                console.error('Error liking comment:', error);
                showNotification('Error', 'Failed to like comment. Please try again.');
            }
        }
        
        // Check subscription status for modal
        async function checkModalSubscriptionStatus(channelId) {
            try {
                const token = await getValidAccessToken();
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&mine=true&forChannelId=${channelId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    const isSubscribed = data.items && data.items.length > 0;
                    updateModalSubscribeButton(isSubscribed);
                } else {
                    // Fallback to local storage
                    const isSubscribed = subscribedChannels.includes(channelId);
                    updateModalSubscribeButton(isSubscribed);
                }
            } catch (error) {
                console.error('Error checking subscription status:', error);
                // Fallback to local storage
                const isSubscribed = subscribedChannels.includes(channelId);
                updateModalSubscribeButton(isSubscribed);
            }
        }
        
        // Update modal subscribe button state
        function updateModalSubscribeButton(isSubscribed) {
            if (isSubscribed) {
                modalSubscribeBtn.textContent = 'Subscribed';
                modalSubscribeBtn.classList.add('subscribed');
            } else {
                modalSubscribeBtn.textContent = 'Subscribe';
                modalSubscribeBtn.classList.remove('subscribed');
            }
        }
        
        // Update like button state
        function updateLikeButton() {
            if (videoLikedStatus) {
                likeBtn.innerHTML = '<i class="fas fa-thumbs-up"></i><span id="likeCount">' + likeCount.textContent + '</span>';
                likeBtn.classList.add('liked');
            } else {
                likeBtn.innerHTML = '<i class="far fa-thumbs-up"></i><span id="likeCount">' + likeCount.textContent + '</span>';
                likeBtn.classList.remove('liked');
            }
        }
        
        // Toggle like video
        async function toggleLikeVideo() {
            if (!isSignedIn || !accessToken) {
                showNotification('Sign In Required', 'Please sign in with Google to like videos.');
                return;
            }
            
            if (!currentVideo) return;
            
            try {
                const token = await getValidAccessToken();
                
                if (videoLikedStatus) {
                    // Remove like via YouTube API
                    await removeLikeFromYouTube(currentVideo.id, token);
                    likedVideos[currentVideo.id] = false;
                    showNotification('Like Removed', 'Video removed from your liked videos');
                } else {
                    // Add like via YouTube API
                    await addLikeToYouTube(currentVideo.id, token);
                    likedVideos[currentVideo.id] = true;
                    showNotification('Liked', 'Video added to your liked videos');
                }
                
                // Update local storage
                localStorage.setItem('edirear_liked_videos', JSON.stringify(likedVideos));
                
                // Update button state
                videoLikedStatus = !videoLikedStatus;
                updateLikeButton();
                
                // Update like count
                const currentCount = parseInt(likeCount.textContent.replace(/[^0-9]/g, ''));
                if (videoLikedStatus) {
                    likeCount.textContent = formatNumber(currentCount + 1);
                } else {
                    likeCount.textContent = formatNumber(Math.max(0, currentCount - 1));
                }
                
            } catch (error) {
                console.error('Error toggling like:', error);
                showNotification('Error', 'Failed to update like. Please try again.');
            }
        }
        
        // Add like to YouTube video
        async function addLikeToYouTube(videoId, token) {
            const response = await fetch(
                `https://www.googleapis.com/youtube/v3/videos/rate?id=${videoId}&rating=like`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                }
            );
            
            if (!response.ok) {
                throw new Error(`YouTube like failed: ${response.status}`);
            }
            
            return true;
        }
        
        // Remove like from YouTube video
        async function removeLikeFromYouTube(videoId, token) {
            const response = await fetch(
                `https://www.googleapis.com/youtube/v3/videos/rate?id=${videoId}&rating=none`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                }
            );
            
            if (!response.ok) {
                throw new Error(`YouTube unlike failed: ${response.status}`);
            }
            
            return true;
        }
        
        // Add video to playlist
        async function addVideoToPlaylist() {
            if (!isSignedIn || !accessToken) {
                showNotification('Sign In Required', 'Please sign in with Google to save videos.');
                return;
            }
            
            if (!currentVideo) return;
            
            try {
                const token = await getValidAccessToken();
                
                // First, get or create "Liked videos" playlist
                const playlistId = await getOrCreateLikedPlaylist(token);
                
                // Add video to playlist
                const playlistItemData = {
                    snippet: {
                        playlistId: playlistId,
                        resourceId: {
                            kind: 'youtube#video',
                            videoId: currentVideo.id
                        }
                    }
                };
                
                const response = await fetch(
                    'https://www.googleapis.com/youtube/v3/playlistItems?part=snippet',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(playlistItemData)
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Failed to add to playlist: ${response.status}`);
                }
                
                showNotification('Saved', 'Video added to your liked videos playlist');
                
            } catch (error) {
                console.error('Error adding to playlist:', error);
                showNotification('Error', 'Failed to save video. Please try again.');
            }
        }
        
        // Get or create "Liked videos" playlist
        async function getOrCreateLikedPlaylist(token) {
            try {
                // First, try to find existing "Liked videos" playlist
                const searchResponse = await fetch(
                    'https://www.googleapis.com/youtube/v3/playlists?part=snippet&mine=true&maxResults=50',
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );
                
                if (searchResponse.ok) {
                    const data = await searchResponse.json();
                    
                    // Look for "Liked videos" playlist
                    const likedPlaylist = data.items.find(playlist => 
                        playlist.snippet.title.toLowerCase().includes('liked') || 
                        playlist.snippet.title.toLowerCase().includes('favorites')
                    );
                    
                    if (likedPlaylist) {
                        return likedPlaylist.id;
                    }
                }
                
                // Create new "Liked videos" playlist
                const playlistData = {
                    snippet: {
                        title: 'Liked videos',
                        description: 'Videos I liked on Edirear'
                    },
                    status: {
                        privacyStatus: 'private'
                    }
                };
                
                const createResponse = await fetch(
                    'https://www.googleapis.com/youtube/v3/playlists?part=snippet,status',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(playlistData)
                    }
                );
                
                if (!createResponse.ok) {
                    throw new Error(`Failed to create playlist: ${createResponse.status}`);
                }
                
                const playlist = await createResponse.json();
                return playlist.id;
                
            } catch (error) {
                console.error('Error getting/creating playlist:', error);
                throw error;
            }
        }
        
        // Toggle share menu
        function toggleShareMenu() {
            if (shareMenu.style.display === 'block') {
                shareMenu.style.display = 'none';
            } else {
                shareMenu.style.display = 'flex';
            }
        }
        
        // Share video to different platforms
        function shareVideo(platform) {
            if (!currentVideo) return;
            
            const videoUrl = `https://www.youtube.com/watch?v=${currentVideo.id}`;
            const videoTitle = currentVideo.snippet.title;
            const shareText = `Check out this video: ${videoTitle}`;
            
            let shareUrl = '';
            
            switch(platform) {
                case 'whatsapp':
                    shareUrl = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + videoUrl)}`;
                    break;
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(videoUrl)}&quote=${encodeURIComponent(shareText)}`;
                    break;
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(videoUrl)}`;
                    break;
                case 'telegram':
                    shareUrl = `https://t.me/share/url?url=${encodeURIComponent(videoUrl)}&text=${encodeURIComponent(shareText)}`;
                    break;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank');
                shareMenu.style.display = 'none';
                showNotification('Shared', `Video shared on ${platform.charAt(0).toUpperCase() + platform.slice(1)}`);
            }
        }
        
        // Copy video link to clipboard
        function copyVideoLink() {
            if (!currentVideo) return;
            
            const videoUrl = `https://www.youtube.com/watch?v=${currentVideo.id}`;
            
            navigator.clipboard.writeText(videoUrl).then(function() {
                showNotification('Link Copied', 'Video link copied to clipboard');
                shareMenu.style.display = 'none';
            }, function(err) {
                console.error('Could not copy text: ', err);
                showNotification('Error', 'Failed to copy link');
            });
        }
        
        // Load suggested videos
        async function loadSuggestedVideos(currentVideo) {
            try {
                suggestedVideos.innerHTML = `
                    <div class="loading" style="grid-column: 1/-1;">
                        <div class="spinner"></div>
                        <div>Loading suggested videos...</div>
                    </div>
                `;
                
                // Use existing user videos as suggestions
                const suggestions = userVideos
                    .filter(video => video.id !== currentVideo.id)
                    .slice(0, 20); // Limit to 20 suggestions
                
                displaySuggestedVideos(suggestions);
                
            } catch (error) {
                console.error('Error loading suggested videos:', error);
                // Fallback to showing random videos from userVideos
                const fallbackSuggestions = userVideos
                    .filter(video => video.id !== currentVideo.id)
                    .slice(0, 10);
                
                displaySuggestedVideos(fallbackSuggestions);
            }
        }
        
        // Display suggested videos
        function displaySuggestedVideos(videos) {
            suggestedVideos.innerHTML = '';
            
            if (videos.length === 0) {
                suggestedVideos.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.7;">No suggested videos available</div>';
                return;
            }
            
            videos.forEach(video => {
                const suggestedItem = document.createElement('div');
                suggestedItem.className = 'suggested-video';
                suggestedItem.setAttribute('data-video-id', video.id);
                
                // Use high-quality thumbnail
                const thumbnailUrl = video.snippet.thumbnails.maxres?.url || 
                                   video.snippet.thumbnails.high?.url || 
                                   video.snippet.thumbnails.medium?.url || 
                                   video.snippet.thumbnails.default?.url ||
                                   `https://picsum.photos/480/270?random=${Math.random()}`;
                
                const title = video.snippet.title;
                const channel = video.snippet.channelTitle;
                const views = formatNumber(video.statistics?.viewCount || '0');
                const publishedAt = formatTimeAgo(video.snippet.publishedAt);
                const duration = formatDuration(parseDuration(video.contentDetails?.duration || 'PT0S'));
                
                // Get channel logo from cache
                const channelId = video.snippet.channelId;
                const channelLogo = channelLogoCache[channelId] || getChannelLogo(channelId, channel);
                
                suggestedItem.innerHTML = `
                    <div class="suggested-thumbnail-container">
                        <img src="${thumbnailUrl}" alt="${title}" class="suggested-thumbnail high-quality-thumbnail" loading="lazy">
                        <div class="video-duration">${duration}</div>
                    </div>
                    <div class="suggested-info">
                        <div class="suggested-title">${title}</div>
                        <div class="suggested-channel-info" data-channel-id="${channelId}" data-channel-name="${channel}">
                            <img src="${channelLogo}" alt="${channel}" class="suggested-channel-logo channel-logo-cached">
                            <div class="suggested-channel">${channel}</div>
                        </div>
                        <div class="suggested-metadata">
                            <span>${views} views</span>
                            <span></span>
                            <span>${publishedAt}</span>
                        </div>
                    </div>
                `;
                
                suggestedItem.addEventListener('click', function() {
                    videoModal.style.display = 'none';
                    if (player) {
                        player.destroy();
                        player = null;
                    }
                    
                    // Hide ad banner
                    adBannerContainer.style.display = 'none';
                    
                    // Clear comment interval
                    if (commentInterval) {
                        clearInterval(commentInterval);
                        commentInterval = null;
                    }
                    
                    // Clear player interval
                    if (playerInterval) {
                        clearInterval(playerInterval);
                        playerInterval = null;
                    }
                    
                    setTimeout(() => {
                        openVideoModal(video);
                    }, 300);
                });
                
                // Add click event to channel info
                const channelInfo = suggestedItem.querySelector('.suggested-channel-info');
                channelInfo.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const channelId = this.getAttribute('data-channel-id');
                    const channelName = this.getAttribute('data-channel-name');
                    openChannelPage(channelId, channelName);
                });
                
                suggestedVideos.appendChild(suggestedItem);
            });
        }
        
        // Format large numbers (e.g., 1234567 -> 1.2M)
        function formatNumber(num) {
            if (!num) return '0';
            
            const number = parseInt(num);
            if (number >= 1000000) {
                return (number / 1000000).toFixed(1) + 'M';
            } else if (number >= 1000) {
                return (number / 1000).toFixed(1) + 'K';
            }
            return number.toString();
        }
        
        // Format time ago (e.g., "2 days ago")
        function formatTimeAgo(publishedAt) {
            const publishedDate = new Date(publishedAt);
            const now = new Date();
            const diffInSeconds = Math.floor((now - publishedDate) / 1000);
            
            if (diffInSeconds < 60) {
                return 'Just now';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else if (diffInSeconds < 2592000) {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days} day${days > 1 ? 's' : ''} ago`;
            } else if (diffInSeconds < 31536000) {
                const months = Math.floor(diffInSeconds / 2592000);
                return `${months} month${months > 1 ? 's' : ''} ago`;
            } else {
                const years = Math.floor(diffInSeconds / 31536000);
                return `${years} year${years > 1 ? 's' : ''} ago`;
            }
        }
    </script>
</body>
</html>